# yamllint disable
# License: The GitLab Enterprise Edition (EE) license (the “EE License”)
# yamllint enable
---
rules:
  - id: javascript_crypto_rule-NodeLibcurlSSLVerificationDisable
    languages:
      - "javascript"
    mode: taint
    pattern-sources:
      - patterns:
          - pattern-either:
              - pattern-inside: |
                  $Y = require('node-libcurl')
                  ...
              - pattern-inside: |
                  import { $Y } from 'node-libcurl'
                  ...
              - pattern-inside: |
                  import { $K as $Y } from 'node-libcurl'
                  ...
          - pattern: |
              $X = new $Y()
    pattern-sinks:
      - patterns:
          - pattern-either:
              - pattern: |
                  $X.setOpt($SSL, 0)
              - pattern: |
                  $X.setOpt($SSL, false)
          - metavariable-pattern:
              metavariable: $SSL
              pattern-either: 
                - pattern: |
                    "SSL_VERIFYHOST"
                - pattern: |
                    "SSL_VERIFYPEER"
                - pattern: |
                    $Y.option.SSL_VERIFYHOST
                - pattern: |
                    $Y.option.SSL_VERIFYPEER
    message: |
      The application was identified disabling the `SSL_VERIFYPEER` and/or the 
      `SSL_VERIFYHOST` options of the node-libcurl library. These options control 
      the verification process of SSL/TLS certificates and hostnames. 
      
      - SSL_VERIFYPEER: This option, when enabled, ensures that the SSL certificate 
      presented by the server is valid and trusted by a Certificate Authority (CA) 
      that the client also trusts. This is crucial for verifying that the server with 
      which the client is connecting is authenticated and its certificate is not forged.
      - SSL_VERIFYHOST: This option, when enabled, makes sure that the certificate's 
      common name (CN) or one of its subject alternative names (SANs) matches the 
      host name in the URL being connected . This is essential for ensuring that 
      the client is communicating with the correct server and not another server 
      presenting a valid certificate.

      Disabling these options compromises the security of SSL/TLS connections. It 
      exposes the application to MITM attacks, where an attacker could intercept, 
      read, or modify the data sent and received over what is assumed to be a secure 
      connection.
    
      Mitigation Strategy:
      To mitigate this vulnerability and ensure secure communication, enable SSL/TLS 
      certificate and hostname verification by setting `SSL_VERIFYPEER` to `1` or 
      `true` and `SSL_VERIFYHOST` to `2`. These options are enabled by default as 
      well. This configuration ensures that the server's SSL certificate is validated 
      against trusted CAs and that the hostname in the certificate matches the hostname 
      the client intends to communicate with.

      Secure Code Example:
      ```
      const { Curl } = require('node-libcurl')
      const curl = new Curl()
      curl.setOpt('SSL_VERIFYPEER', 1)
      curl.setOpt('SSL_VERIFYHOST', 2)
      curl.setOpt('URL', 'https://yourserver.com:443')
      ```
    severity: "WARNING"
    metadata:
      owasp:
        - "A6:2017-Security Misconfiguration"
        - "A05:2021-Security Misconfiguration"
      cwe: "CWE-599"
      shortDescription: "Missing validation of OpenSSL certificate"
      security-severity: "MEDIUM"
      category: "security"
