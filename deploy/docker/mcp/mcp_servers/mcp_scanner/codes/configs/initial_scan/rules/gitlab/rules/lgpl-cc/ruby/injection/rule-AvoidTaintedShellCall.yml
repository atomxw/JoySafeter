# yamllint disable
# License: Commons Clause License Condition v1.0[LGPL-2.1-only]
# yamllint enable
---
rules:
- id: ruby_injection_rule-AvoidTaintedShellCall
  mode: taint
  pattern-sources:
  - pattern-either:
    - pattern: params[...]
    - pattern: cookies
    - pattern: request.env
  pattern-sinks:
  - patterns:
    - pattern-either:
      - patterns:
        - pattern: Kernel.$X(...)
      - patterns:
        - pattern-either:
          - pattern: Shell.$X(...)
          - patterns:
            - pattern-inside: |
                $SHELL = Shell.$ANY(...)
                ...
                $SHELL.$X(...)
            - pattern: $SHELL.$X(...)
    - metavariable-pattern:
        metavariable: $X
        patterns:
        - pattern-either:
          - pattern: cat
          - pattern: chdir
          - pattern: chroot
          - pattern: delete
          - pattern: entries
          - pattern: exec
          - pattern: foreach
          - pattern: glob
          - pattern: install
          - pattern: lchmod
          - pattern: lchown
          - pattern: link
          - pattern: load
          - pattern: load_file
          - pattern: makedirs
          - pattern: move
          - pattern: new
          - pattern: open
          - pattern: read
          - pattern: readlines
          - pattern: rename
          - pattern: rmdir
          - pattern: safe_unlink
          - pattern: symlink
          - pattern: syscopy
          - pattern: sysopen
          - pattern: system
          - pattern: truncate
          - pattern: unlink
  message: |
    User input should never be used in constructing commands or command arguments
    to functions which execute OS related functionality. Using external 
    input without validation in functions like `Kernel.system`, `exec`, or any 
    operations that interact with the shell or file system (`cat`, `delete` 
    etc.) poses a severe security risk. These patterns can lead to command 
    injection vulnerabilities, where an attacker could execute arbitrary 
    commands on the system the application is hosted on, leading to data 
    breaches, unauthorized access, or worse.

    To prevent command injection vulnerabilities, validate and sanitize all 
    user input before using it in any system or shell operation. Additionally, 
    consider using safer alternatives for executing system commands that don't 
    directly pass user input to the shell, such as parameterized APIs or 
    functions that handle arguments safely.

    Secure Code Example:
    ```
    user_filename_key = params[:filename_key]

    allowed_filenames = {
      'file1' => 'allowed_file_1.txt',
      'file2' => 'allowed_file_2.txt',
    }

    # Validate and select the filename from the lookup table
    if allowed_filenames.has_key?(user_filename_key)
      safe_filename = allowed_filenames[user_filename_key]

      # Use a safer API to read file content without invoking the shell
      content = File.read(safe_filename)
    else
      puts "Invalid filename."
    end
    ```
  languages: 
  - "ruby"
  severity: "ERROR"
  metadata:
    shortDescription: "Improper neutralization of special elements used in an OS command
      ('OS Command Injection')"
    category: "security"
    owasp:
    - "A1:2017-Injection"
    - "A03:2021-Injection"
    cwe: "CWE-78"
    security-severity: "HIGH"
    technology:
    - "rails"
    - "ruby"
    references:
    - "https://github.com/semgrep/semgrep-rules/blob/develop/ruby/rails/security/audit/avoid-tainted-shell-call.yaml"
  