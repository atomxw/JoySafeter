# yamllint disable
# License: Commons Clause License Condition v1.0[LGPL-2.1-only]
# yamllint enable
---
rules:
- id: java_file_rule_rule-FilePathTraversalHttpServlet
  languages:
  - "java"
  severity: ERROR
  metadata:
    security-severity: CRITICAL
    shortDescription: "Improper Limitation of a Pathname to a Restricted Directory
        ('Path Traversal')"
    cwe: "CWE-22"
    owasp:
    - "A5:2017-Broken Access Control"
    - "A01:2021-Broken Access Control"
    source-rule-url: https://find-sec-bugs.github.io/bugs.htm#PATH_TRAVERSAL_IN
    references:
    - https://www.owasp.org/index.php/Path_Traversal
    category: "security"
    technology:
    - "java"
    cwe2022-top25: true
    cwe2021-top25: true
    impact: MEDIUM
    confidence: MEDIUM
    license: Commons Clause License Condition v1.0[LGPL-2.1-only]
    vulnerability_class:
    - Path Traversal
  message: |
    Detected a potential path traversal. A malicious actor could control
    the location of this file, to include going backwards in the directory
    with '../'. 
    
    To address this, ensure that user-controlled variables in file
    paths are sanitized. You may also consider using a utility method such as
    org.apache.commons.io.FilenameUtils.getName(...) to only retrieve the file
    name from the path.
    
    Example code using FilenameUtils.getName(...)
    
    ```
    public void ok(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {
        String image = request.getParameter("image");
        File file = new File("static/images/", FilenameUtils.getName(image));

        if (!file.exists()) {
            log.info(image + " could not be created.");
            response.sendError();
        }

        response.sendRedirect("/index.html");
    }
    ```
  mode: "taint"
  pattern-sources:
  - patterns:
    - pattern-either:
      - pattern: |
          (HttpServletRequest $REQ)
      - patterns:
        - pattern-inside: >
            (javax.servlet.http.Cookie[] $COOKIES) =
            (HttpServletRequest $REQ).getCookies(...);
            ...

            for (javax.servlet.http.Cookie $COOKIE: $COOKIES) {
              ...
            }
        - pattern: |
            $COOKIE.getValue(...)
      - patterns:
        - pattern-inside: |
            $TYPE[] $VALS = (HttpServletRequest $REQ).$GETFUNC(...);
            ...
        - pattern: |
            $PARAM = $VALS[$INDEX];
  pattern-sanitizers:
  - pattern: org.apache.commons.io.FilenameUtils.getName(...)
  pattern-sinks:
  - patterns:
    - pattern-either:
      - pattern: |
          (java.io.File $FILE) = ...
      - pattern: |
          (java.io.FileOutputStream $FOS) = ...
      - pattern: |
          new java.io.FileInputStream(...)
