# yamllint disable
# License: GNU Lesser General Public License v3.0
# source (original): https://github.com/mobsf/mobsfscan/blob/main/mobsfscan/rules/patterns/ios/oc/objective_c_rules.yaml
# hash: e29e85c3
# yamllint enable
---
rules:
  - id: rules_lgpl_oc_other_rule-ios-self-signed-ssl
    pattern-either:
      - pattern: canAuthenticateAgainstProtectionSpace
      - pattern: continueWithoutCredentialForAuthenticationChallenge
      - pattern: kCFStreamSSLAllowsExpiredCertificates
      - pattern: kCFStreamSSLAllowsAnyRoot
      - pattern: kCFStreamSSLAllowsExpiredRoots
      - patterns:
          - pattern: validatesSecureCertificate = $NO
          - metavariable-regex:
              metavariable: "$NO"
              regex: "NO|no"
      - patterns:
          - pattern: allowInvalidCertificates = $YES
          - metavariable-regex:
              metavariable: "$YES"
              regex: "YES|yes"
    paths:
      include:
        - "**/*.m"
    message: |
      App allows self signed or invalid SSL certificates. App is 
      vulnerable to MITM attacks. If the app does not verify the 
      authenticity of the server's SSL certificate, an attacker could 
      impersonate the server and intercept sensitive data transmitted 
      between the app and the server.
      To fix these security issues, you should ensure proper SSL 
      certificate validation in your Objective-C code. Here's how you 
      can do it:
      ```
      - (void)loadSecureURL {
        NSURL *url = [NSURL URLWithString:@"https://example.com"];
        NSURLRequest *request = [NSURLRequest requestWithURL:url];
      
        // Create session configuration
        NSURLSessionConfiguration *configuration = [NSURLSessionConfiguration defaultSessionConfiguration];
        configuration.TLSMinimumSupportedProtocol = kTLSProtocol12;
      
        // Create session with configuration
        NSURLSession *session = [NSURLSession sessionWithConfiguration:configuration];
      
        // Create data task
        NSURLSessionDataTask *task = [session dataTaskWithRequest:request completionHandler:^(NSData * _Nullable data, NSURLResponse * _Nullable response, NSError * _Nullable error) {
            if (error) {
                NSLog(@"Error loading URL: %@", error);
                // Handle error
            } else {
                // Handle response
                NSLog(@"Response: %@", response);
            }
        }];
      
        // Start task
        [task resume];
      }

      ```

    languages:
      - generic
    severity: ERROR
    metadata:
      category: security
      cwe: "CWE-676"
      shortDescription: "Use of potentially dangerous function"
      owasp:
        - "A9:2017-Using Components with Known Vulnerabilities"
        - "A06:2021-Vulnerable and Outdated Components"
      security-severity: CRITICAL