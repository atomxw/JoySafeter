# yamllint disable
# License: Commons Clause License Condition v1.0[LGPL-2.1-only]
# yamllint enable
---
rules:
  - id: "ruby_file_rule-CheckRenderLocalFileInclude"
    mode: taint
    pattern-sources:
      - patterns:
          - pattern: params[...]
    pattern-sinks:
      - patterns:
          - pattern-either:
              - pattern: |
                  render ..., file: $X
              - pattern: |
                  render ..., inline: $X
              - pattern: |
                  render ..., template: $X
              - pattern: |
                  render ..., action: $X
              - pattern: |
                  render $X, ...
          - focus-metavariable: $X
    pattern-sanitizers:
      - patterns:
          - pattern: $MAP[...]
          - metavariable-pattern:
              metavariable: $MAP
              patterns:
                - pattern-not-regex: params
      - pattern: File.basename(...)
    message: |
      The application dynamically constructs file or path information with user input when calling the `render` function. This can allow end
      users to request arbitrary local files which may result in leaking
      sensitive information persisted on disk. Where possible, avoid letting
      users specify template paths for `render`. If you must allow user input,
      use an allow-list of known templates or normalize the user-supplied value
      with `File.basename(...)`.

      To mitigate this vulnerability, follow these steps:
      - Avoid direct user input: If possible, do not use user input 
      to determine file paths. Use a mapping of user input to server-side 
      defined file paths instead.
      - Use `File.basename`: If user input must be used to specify a file, 
      ensure that the input is normalized using `File.basename` to extract 
      the filename without any directory path. This prevents directory 
      traversal attacks.
      - Path allow listing: Implement an allow list of permitted files or 
      directories and check user input against this list before processing.
      
      Secure Code Example:
      ```
      class PagesController < ApplicationController
        # Allowlist
        def show
          valid_pages = ['home', 'about_us', 'contact']
          if valid_pages.include?(params[:page])
            render params[:page]
          else
            render 'not_found'
          end
        end
      
        # Sanitizing User Input
        def show
            # Sanitize the user input to extract just the file name
            page = File.basename(params[:page])
            # Optionally, further validate the sanitized input against an allow-list or other criteria
            render page
        end
      end
      ```
    languages: 
      - "ruby"
    severity: "WARNING"
    metadata:
      owasp:
        - "A5:2017-Broken Access Control"
        - "A01:2021-Broken Access Control"
      cwe: "CWE-22"
      shortDescription: "Improper limitation of a pathname to a restricted directory 
      ('Path Traversal')"    
      references:
        - "https://owasp.org/www-project-web-security-testing-guide/v42/4-Web_Application_Security_Testing/07-Input_Validation_Testing/11.1-Testing_for_Local_File_Inclusion"
        - "https://github.com/semgrep/semgrep-rules/blob/develop/ruby/rails/security/brakeman/check-render-local-file-include.yaml"
      category: "security"
      security-severity: "MEDIUM"
      technology:
        - "rails"
