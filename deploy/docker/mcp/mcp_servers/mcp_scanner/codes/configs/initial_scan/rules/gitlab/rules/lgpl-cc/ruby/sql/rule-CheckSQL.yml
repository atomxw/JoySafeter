# yamllint disable
# License: Commons Clause License Condition v1.0[LGPL-2.1-only]
# yamllint enable
---
rules:
- id: "ruby_sql_rule-CheckSQL"
  mode: taint
  pattern-sources:
  - pattern-either:
    - pattern: |
        cookies[...]
    - patterns:
      - pattern: |
          cookies. ... .$PROPERTY[...]
      - metavariable-regex:
          metavariable: $PROPERTY
          regex: (?!signed|encrypted)
    - pattern: |
        params[...]
    - pattern: |
        request.env[...]
  pattern-sanitizers:
  - patterns:
    - pattern-either:
      - patterns:
        - pattern: $X
        - pattern-either:
          - pattern-inside: |
              :$KEY => $X
          - pattern-inside: |
              ["...",$X,...]
      - pattern: |
          params[...].to_i
      - pattern: |
          params[...].to_f
      - patterns:
        - pattern: |
            params[...] ? $A : $B
        - metavariable-pattern:
            metavariable: $A
            patterns:
            - pattern-not: |
                params[...]
        - metavariable-pattern:
            metavariable: $B
            patterns:
            - pattern-not: |
                params[...]
  pattern-sinks:
  - patterns:
    - pattern: $X
    - pattern-not-inside: |
        $P.where("...",...)
    - pattern-not-inside: |
        $P.where(:$KEY => $VAL,...)
    - pattern-either:
      - pattern-inside: |
          $P.$M(...)
      - pattern-inside: |
          $P.$M("...",...)
    - pattern-inside: |
        class $P < ActiveRecord::Base
          ...
        end
    - metavariable-regex:
        metavariable: $M
        regex: (where|find|first|last|select|minimum|maximum|calculate|sum|average)
  message: |
    SQL Injection is a critical vulnerability that can lead to data or system compromise. By
    dynamically generating SQL query strings, user input may be able to influence the logic of
    the SQL statement. This could lead to an adversary accessing information they should
    not have access to, or in some circumstances, being able to execute OS functionality or code.

    To mitigate this issue, always use parameterized queries or the 
    ActiveRecord query interface, which ensures that inputs are properly 
    escaped, preventing SQL injection attacks. Avoid string interpolation 
    or concatenation with user-controlled input for constructing SQL queries.

    Secure Code Example:
    ```
    # Secure: Using parameterized queries with ActiveRecord
    user_id = params[:id]
    User.where("id = ?", user_id)

    # Secure: Using ActiveRecord's query methods, which automatically handle parameterization
    # Converting to integer as an additional layer of input sanitization
    user_id = params[:id].to_i  
    User.where(id: user_id)
    ```
  languages:
  - "ruby"
  severity: "ERROR"
  metadata:
    shortDescription: "Improper neutralization of special elements used in a SQL
      command ('SQL Injection')"
    category: "security"
    cwe: "CWE-89"
    owasp:
    - "A1:2017-Injection"
    - "A03:2021-Injection"
    security-severity: "HIGH"
    technology:
    - "ruby"
    - "rails"
    references:
    - "https://owasp.org/www-community/attacks/SQL_Injection"
    - "https://github.com/semgrep/semgrep-rules/blob/develop/ruby/rails/security/brakeman/check-sql.yaml"