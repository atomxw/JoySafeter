# yamllint disable
# License: Commons Clause License Condition v1.0[LGPL-2.1-only]
# source (original): https://github.com/semgrep/semgrep-rules/blob/release/java/lang/security/audit/dangerous-groovy-shell.yaml
# yamllint enable
---
rules:
  - id: java_inject_rule-DangerousGroovyShell
    languages:
      - java
    patterns:
      - pattern-either:
          - pattern: |
              (groovy.lang.GroovyShell $SHELL).parse(...)
          - pattern: |
              (groovy.lang.GroovyShell $SHELL).evaluate(...)
          - pattern: |
              (groovy.lang.GroovyClassLoader $SHELL).parseClass(...)
      - pattern-not: |
          $SHELL.parse("...",...)
      - pattern-not: |
          $SHELL.evaluate("...",...)
      - pattern-not: |
          $SHELL.parseClass("...",...)
      - pattern-not-inside: |
          if($ALLOWLIST.contains($INPUT)){
            ...
          }
    message: |
        This application implements unsafe invocations of methods within the
        `groovy.lang.GroovyShell` or `groovy.lang.GroovyClassLoader` classes,
        which are used to evaluate or compile Groovy code dynamically. When
        user-controlled input is directly passed to `parse`, `evaluate`, or
        `parseClass` methods, it can lead to Remote Code Execution (RCE), where an
        attacker can execute arbitrary code on the server. This could potentially
        allow an attacker to gain unauthorized access to system resources, modify
        internal application states, or execute commands on the server depending
        on the level of permissions assigned to the application process.

        To mitigate this vulnerability, always validate and sanitize all user inputs 
        before using them in dynamic code evaluations. Consider using safer alternatives 
        to executing dynamic code if possible. If dynamic code execution is absolutely 
        necessary, use strict allowlists of safe inputs and context-specific validation.

        Secure Code Example:

        ```
        import groovy.lang.GroovyShell;

        class SafeDynamicEvaluation {
          private static final Set<String> ALLOWED_EXPRESSIONS = new HashSet<>(Arrays.asList(
              "println 'Hello World!'",
              "println 'Goodbye World!'"));

          public static void test4(String[] args, ClassLoader loader) throws Exception {
            GroovyShell shell = new GroovyShell();
            String userInput = args[0];

            // Validate the user input against the allowlist
            if (ALLOWED_EXPRESSIONS.contains(userInput)) {
              shell.evaluate(userInput);
              // shell.parse(userInput);
            } else {
              throw new IllegalArgumentException("Invalid or unauthorized command.");
            }
          }
        }
        ```
    metadata:
      shortDescription: "Improper control of generation of code ('Code Injection')"
      category: "security"
      cwe: "CWE-94"
      owasp:
        - "A1:2017-Injection"
        - "A03:2021-Injection"
      security-severity: "CRITICAL"
      source-rule-url: "https://find-sec-bugs.github.io/bugs.htm#GROOVY_SHELL"
      technology:
        - "groovy"
      references:
        - "https://owasp.org/Top10/A03_2021-Injection"
      cwe2022-top25: "true"
      license: "Commons Clause License Condition v1.0[LGPL-2.1-only]"
      vulnerability_class:
        - "Code Injection"
    severity: "ERROR"
