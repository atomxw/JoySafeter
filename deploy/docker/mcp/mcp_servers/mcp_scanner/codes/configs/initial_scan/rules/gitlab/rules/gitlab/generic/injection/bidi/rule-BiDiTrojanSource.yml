# yamllint disable
# License: The GitLab Enterprise Edition (EE) license (the "EE License")
# This rule detects Unicode BiDi override characters that can be used to create 
# trojan source attacks (CVE-2021-42574, CWE-838). These characters can make
# source code appear different from its actual logic, potentially hiding malicious code.
#
# Severity: High - Can lead to code reviews missing malicious content
# False Positives: Low - BiDi override characters are rarely needed in source code
# Performance Impact: Low - Simple regex pattern matching
# yamllint enable
---
rules:
  - id: "generic_injection_rule-BiDiTrojanSource"
    languages:
      - "generic"
    pattern-regex: '[\x{202A}-\x{202E}\x{2066}-\x{2069}\x{200E}\x{200F}\x{061C}]'
    message: |
      Unicode bidirectional (BiDi) control characters were detected in source code.
      These characters can be used to reorder text and hide malicious code 
      (CVE-2021-42574).
      
      BiDi override characters can make code appear different from its actual logic:
      - Text that appears as a comment might actually be executable code
      - Code that appears harmless might contain hidden malicious logic
      - Variable names and string literals may not reflect their true content
      
      Mitigation Steps:
      - Remove any BiDi override characters
      - Only use standard ASCII characters in source code
      - If BiDi characters are required, thoroughly review the code
      
      Secure Code Example:
      ```java
      public class DataProcessor {
          // Use standard ASCII characters only
          public void processData(String data) {
              String cleanInput = data.trim();  // Clean the input
              System.out.println("Processing: " + cleanInput);  // Clear, readable code
          }
      }
      ```

      References:
      - https://nvd.nist.gov/vuln/detail/CVE-2021-42574
      - https://trojansource.codes/
    metadata:
      shortDescription: "Improper control of generation of code ('Code Injection')"
      cwe: "CWE-94"
      owasp:
        - "A03:2021-Injection"
        - "A1:2017-Injection"
      category: "security"
      security-severity: "Low"
    severity: "WARNING"
    paths:
      include:
        - "*.py"
        - "*.js"
        - "*.java"
        - "*.c"
        - "*.cpp"
        - "*.cs"
        - "*.go"
        - "*.rs"
        - "*.php"
        - "*.rb"
        - "*.scala"
        - "*.ts"
        - "*.kt"
        - "*.m"
        - "*.swift"
