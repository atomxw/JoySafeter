# yamllint disable
# License: Commons Clause License Condition v1.0[LGPL-2.1-only]
# yamllint enable
---
rules:
- id: "ruby_reflection_rule-CheckUnsafeReflection"
  mode: taint
  pattern-sources:
  - pattern-either:
    - pattern: |
        cookies[...]
    - patterns:
      - pattern: |
          cookies. ... .$PROPERTY[...]
      - metavariable-regex:
          metavariable: $PROPERTY
          regex: (?!signed|encrypted)
    - pattern: |
        params[...]
    - pattern: |
        request.env[...]
  pattern-sinks:
  - patterns:
    - pattern: $X
    - pattern-either:
      - pattern-inside: |
          $X.constantize
      - pattern-inside: |
          $X. ... .safe_constantize
      - pattern-inside: |
          const_get(...)
      - pattern-inside: |
          qualified_const_get(...)
  message: |
    The application was found calling a reflection method with user-controllable
    input. Reflection in Ruby allows a program to examine and modify its own 
    structure and behavior at runtime. When user input is used unsafely 
    with reflection methods (like `constantize`, `safe_constantize`, `const_get`, 
    `qualified_const_get`), it poses a significant security risk, potentially 
    leading to arbitrary code execution.

    To mitigate these risks:
    - Avoid direct user input in reflection: Never use user-controllable input 
    directly with reflection methods.
    - Validate and sanitize input: If user input must influence program behavior, 
    rigorously validate and sanitize the input against a whitelist of allowed 
    values.
    - Use indirect references: Instead of allowing direct specification of class 
    or method names, map user inputs to a predefined set of allowed actions or 
    classes.
    - Do not provide user-controllable input to reflection functionality. 
    - Do not call symbol conversion on user-controllable input.

    Secure Code Example:
    ```
    class SafeClassHandler
      ALLOWED_CLASSES = {
        'user' => User,
        'product' => Product
      }.freeze

      def self.handle_class_action(class_key)
        klass = ALLOWED_CLASSES[class_key]
        raise ArgumentError, "Invalid class key" unless klass

        klass.some_method
      end
    end

    # Example usage
    SafeClassHandler.handle_class_action(params[:class_key])
    ```
  languages:
  - "ruby"
  severity: "ERROR"
  metadata:
    shortDescription: "Improper control of generation of code ('Code Injection')"
    category: "security"
    cwe: "CWE-94"
    owasp:
    - "A1:2017-Injection"
    - "A03:2021-Injection"
    security-severity: "HIGH"
    technology:
    - "ruby"
    - "rails"
    references:
    - "https://github.com/semgrep/semgrep-rules/blob/develop/ruby/rails/security/brakeman/check-unsafe-reflection.yaml"
