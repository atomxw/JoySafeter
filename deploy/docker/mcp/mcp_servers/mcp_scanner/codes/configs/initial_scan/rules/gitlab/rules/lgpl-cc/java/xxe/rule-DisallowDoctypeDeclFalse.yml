# yamllint disable
# License: Commons Clause License Condition v1.0[LGPL-2.1-only]
# https://github.com/semgrep/semgrep-rules/blob/release/java/lang/security/audit/xxe/documentbuilderfactory-disallow-doctype-decl-false.yaml
# yamllint enable
---
rules:
  - id: java_xxe_rule-DisallowDoctypeDeclFalse
    severity: "WARNING"
    languages:
      - "java"
    metadata:
      cwe: "CWE-611"
      shortDescription: "Improper restriction of XML external entity reference"
      owasp:
        - "A4:2017-XML External Entities (XXE)"
        - "A05:2021-Security Misconfiguration"
      security-severity: "MEDIUM"
      references:
        - "https://semgrep.dev/blog/2022/xml-security-in-java"
        - "https://semgrep.dev/docs/cheat-sheets/java-xxe/"
        - "https://blog.sonarsource.com/secure-xml-processor"
        - "https://xerces.apache.org/xerces2-j/features.html"
      category: "security"
      technology:
        - "java"
        - "xml"
      cwe2022-top25: "true"
      cwe2021-top25: "true"
      likelihood: "LOW"
      impact: "HIGH"
      confidence: "HIGH"
      license: "Commons Clause License Condition v1.0[LGPL-2.1-only]"
      vulnerability_class:
        - "XML Injection"
    message: |
      DOCTYPE declarations are enabled for $DBFACTORY. Without prohibiting
      external entity declarations, this is vulnerable to XML external entity
      attacks. In an XXE attack, an attacker can exploit the processing of external 
      entity references within an XML document to access internal files, conduct 
      denial-of-service attacks, or SSRF (Server Side Request Forgery), potentially 
      leading to sensitive information disclosure or system compromise.

      To mitigate this vulnerability, disable this by setting the feature
      "http://apache.org/xml/features/disallow-doctype-decl" to true.
      Alternatively, allow DOCTYPE declarations and only prohibit external
      entities declarations. This can be done by setting the features
      "http://xml.org/sax/features/external-general-entities" and
      "http://xml.org/sax/features/external-parameter-entities" to false.

      Secure Code Example: 
      ``` 
      public void GoodXMLInputFactory() throws  ParserConfigurationException {
        DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();
        dbf.setFeature("http://apache.org/xml/features/disallow-doctype-decl", true);
      } 
      ```
    patterns:
      - pattern: |
          $DBFACTORY.setFeature("http://apache.org/xml/features/disallow-doctype-decl",
          false);
      - pattern-not-inside: >
          $RETURNTYPE $METHOD(...){
            ...
            $DBF.setFeature("http://xml.org/sax/features/external-general-entities", false);
            ...
            $DBF.setFeature("http://xml.org/sax/features/external-parameter-entities", false);
            ...
          }
      - pattern-not-inside: >
          $RETURNTYPE $METHOD(...){
            ...
            $DBF.setFeature("http://xml.org/sax/features/external-parameter-entities", false);
            ...
            $DBF.setFeature("http://xml.org/sax/features/external-general-entities", false);
            ...
          }
      - pattern-not-inside: |
          $RETURNTYPE $METHOD(...){
            ...
            $DBF.setAttribute(XMLConstants.ACCESS_EXTERNAL_DTD, "");
            ...
            $DBF.setAttribute(XMLConstants.ACCESS_EXTERNAL_SCHEMA, "");
            ...
          }
      - pattern-not-inside: |
          $RETURNTYPE $METHOD(...){
            ...
            $DBF.setAttribute(XMLConstants.ACCESS_EXTERNAL_SCHEMA, "");
            ...
            $DBF.setAttribute(XMLConstants.ACCESS_EXTERNAL_DTD, "");
            ...
          }

