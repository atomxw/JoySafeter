# yamllint disable
# License: GNU Lesser General Public License v3.0
# source (original): https://github.com/ajinabraham/njsscan/blob/master/njsscan/rules/semantic_grep/jwt/jwt_exposed_credentials.yaml
# hash: e7a0a61
# yamllint enable
---
rules:
- id: "rules_lgpl_javascript_jwt_rule-jwt-exposed-credentials"
  patterns:
  - pattern-either:
    - pattern-inside: |
        const $JWT = require("jsonwebtoken");
        ...
    - pattern-inside: |
        const $JOSE = require("jose");
        ...
    - pattern-inside: |
        import $JWT from "jsonwebtoken"
        ...
    - pattern-inside: |
        import $JOSE from "jose"
        ...
  - pattern-either:
    - pattern: "$JWT.sign(<... {$PASSWORD: $VALUE} ...>, ...)"
    - patterns:
      - pattern: |
          $OBJ = <... {$PASSWORD: $VALUE} ...>
          ...
          $TOKEN = $JWT.sign(<... $OBJ ...>, ...)
      - pattern: $TOKEN = $JWT.sign(<... $OBJ ...>, ...)
    - patterns:
      - pattern: |
          $OBJ. ... .$PASSWORD = ...
          ...
          $TOKEN = $JWT.sign(<... $OBJ ...>, ...)
      - pattern: $TOKEN = $JWT.sign(<... $OBJ ...>, ...)
    - pattern: "new $JOSE.SignJWT(<... {$PASSWORD: $VALUE} ...>)"
    - patterns:
      - pattern: |
          $OBJ = <... {$PASSWORD: $VALUE} ...>
          ...
          new $JOSE.SignJWT(<... $OBJ ...>)
      - pattern: new $JOSE.SignJWT(<... $OBJ ...>)
    - patterns:
      - pattern: |
          $OBJ. ... .$PASSWORD = ...
          ...
          new $JOSE.SignJWT(<... $OBJ ...>)
      - pattern: new $JOSE.SignJWT(<... $OBJ ...>)
  - metavariable-regex:
      metavariable: $PASSWORD
      regex: (?i)\b(?:.*password.*)\b
  severity: "ERROR"
  languages:
  - "javascript"
  metadata:
    owasp: 
    - "A3:2017-Sensitive Data Exposure"
    - "A02:2021-Cryptographic Failures"
    cwe: "CWE-522"
    shortDescription: "Insufficiently protected credentials"
    security-severity: "HIGH"
    category: "security"
  message: |
    The application is storing a password in the JWT token payload. Storing 
    passwords in JWT token payloads is an insecure practice that can lead to 
    compromised credentials. 

    The password transmitted in the JWT payload is not encrypted and therefore 
    visible to anyone who intercepts the token. It is recommended to avoid storing 
    sensitive information like passwords in JWTs. Instead, reference user identifiers 
    that map to credentials stored securely on the server.This helps to mitigate the 
    risk of exposing passwords through JWT tokens that could be intercepted or leaked.

    Secure code example of secure JWT signing:
    ```
    router.route("/jsonwebtoken/1").get((req, res) => {
      // any payload without passwords or any other sensitive data will be secure
      const payload = { user_id: 123, username: 'john_doe' };
      const token = jwt.sign(payload, secretKey, { algorithm: 'HS256' });
      console.log('Generated Token:', token);
      res.send({ token })
    })
    ```