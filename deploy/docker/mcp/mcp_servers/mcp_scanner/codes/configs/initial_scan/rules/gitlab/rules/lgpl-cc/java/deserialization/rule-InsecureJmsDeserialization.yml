# yamllint disable
# License: Commons Clause License Condition v1.0[LGPL-2.1-only]
# https://github.com/semgrep/semgrep-rules/blob/release/java/lang/security/insecure-jms-deserialization.yaml
# yamllint enable
---
rules:
  - id: java_deserialization_rule-InsecureJmsDeserialization
    languages:
      - java
    patterns:
      - pattern-inside: |
          class $JMS_LISTENER implements MessageListener {
            ...
            public void onMessage(Message $JMS_MSG) {
                ...
            }
          }
      - pattern: $Y.getObject(...);
    message: |
      Deserialization of untrusted JMS ObjectMessage can lead to arbitrary 
      code execution. This vulnerability occurs when `ObjectMessage.getObject()` 
      is called to deserialize the payload of an ObjectMessage, potentially 
      allowing remote attackers to execute arbitrary code with the permissions 
      of the JMS MessageListener application. 
      
      To mitigate the issue, avoid deserialization of untrusted data and 
      consider alternative message formats or explicit whitelisting of 
      allowable classes for deserialization.

      To implement allowlisting, override the ObjectInputStream#resolveClass() 
      method to limit deserialization to allowed classes only. This prevents 
      deserialization of any class except those explicitly permitted, such as 
      in the following example that restricts deserialization to the Bicycle 
      class only:

      ```
      // Code from https://cheatsheetseries.owasp.org/cheatsheets/Deserialization_Cheat_Sheet.html
      public class LookAheadObjectInputStream extends ObjectInputStream {
          public LookAheadObjectInputStream(InputStream inputStream) throws IOException {
              super(inputStream);
          }
          /**
          * Only deserialize instances of our expected Bicycle class
          */
          @Override
          protected Class<?> resolveClass(ObjectStreamClass desc) throws IOException, ClassNotFoundException {
              if (!desc.getName().equals(Bicycle.class.getName())) {
                  throw new InvalidClassException("Unauthorized deserialization attempt", desc.getName());
              }
              return super.resolveClass(desc);
          }
      }
      ```
    metadata:
      cwe: "CWE-502"
      owasp:
        - "A8:2017-Insecure Deserialization"
        - "A08:2021-Software and Data Integrity Failures"
      category: "security"
      shortDescription: "Deserialization of untrusted data"
      security-severity: "High"
      references:
        - "https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities-wp.pdf"
      technology:
        - "java"
      cwe2022-top25: "true"
      cwe2021-top25: "true"
      subcategory:
        - "vuln"
      likelihood: "LOW"
      impact: "MEDIUM"
      confidence: "MEDIUM"
      license: "Commons Clause License Condition v1.0[LGPL-2.1-only]"
      vulnerability_class:
        - "Insecure Deserialization "
    severity: "ERROR"