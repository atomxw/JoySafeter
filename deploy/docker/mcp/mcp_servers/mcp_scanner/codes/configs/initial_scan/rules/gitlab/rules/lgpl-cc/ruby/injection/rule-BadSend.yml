# yamllint disable
# License: Commons Clause License Condition v1.0[LGPL-2.1-only]
# yamllint enable
---
rules:
- id: "ruby_injection_rule-BadSend"
  pattern-either:
  - pattern: |
      $PARAM = params[...]
      ...
      $RES = $MOD.send($PARAM.$FUNC)
  - pattern: |
      $PARAM = params[...]
      ...
      $RES = $MOD.try($PARAM.$FUNC)
  - pattern: |
      $PARAM = params[...]
      ...
      $RES = $MOD.__send__($PARAM.$FUNC)
  - pattern: |
      $PARAM = params[...]
      ...
      $RES = $MOD.public_send($PARAM.$FUNC)
  message: |
    The application was found calling dynamic method invocations in Ruby. 
    In particular one of the methods of: `Object#send`, `Object#try`, `Object#__send__`, 
    or `Object#public_send`. These methods are powerful Ruby features that allow 
    calling another method on an object 
    by name, where the method's name is passed as a string or symbol. 
    However, when combined with untrusted input, such as parameters from 
    web requests, they can lead to severe security vulnerabilities, including 
    arbitrary method execution and potentially arbitrary code execution.

    To mitigate these risks, it's crucial to validate and sanitize any user 
    input that might determine which methods are invoked. Moreover, consider 
    using safer alternatives to direct method invocation based on user input, 
    such as explicitly whitelisting allowed methods or using conditional logic 
    to determine method calls.

    Secure Code Example:
    ```
    # Secure method invocation with validation and allow lists
    method_name = params[:method].to_sym
    allowed_methods = [:allowed_method_1, :allowed_method_2, :safe_method]

    if allowed_methods.include?(method_name)
      result = object.public_send(method_name)
    else
      raise "Unauthorized method call"
    end
    ```
  languages:
  - "ruby"
  severity: "ERROR"
  metadata:
    shortDescription: "Improper control of generation of code ('Code Injection')"
    category: "security"
    cwe: "CWE-94"
    owasp:
    - "A1:2017-Injection"
    - "A03:2021-Injection"
    security-severity: "HIGH"
    technology:
    - "ruby"
    references:
    - "https://github.com/semgrep/semgrep-rules/blob/develop/ruby/lang/security/no-send.yaml"
    - "https://the.igreque.info/posts/2016/01-object-send-considered-harmful-en.html"
    
  