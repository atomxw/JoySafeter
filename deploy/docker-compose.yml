# =============================================================================
# Docker Compose 配置文件
# =============================================================================
# 注意：此文件中的端口映射使用环境变量，需要在 deploy/.env 文件中定义
# 如果 deploy/.env 不存在，Docker Compose 会使用默认值
# 
# 创建环境变量文件：
#   cp .env.example .env
#   然后根据需要修改 .env 文件中的端口配置
# =============================================================================

services:
  # PostgreSQL 数据库
  db:
    image: postgres:15-alpine
    restart: always
    container_name: joysafeter-db
    volumes:
      - joysafeter-db-data:/var/lib/postgresql/data
    env_file:
      - ../backend/.env
    environment:
      # PostgreSQL 镜像固定配置
      - PGDATA=/var/lib/postgresql/data
    ports:
      - "${POSTGRES_PORT_HOST:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-joysafeter}"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s
    networks:
      - joysafeter-network

  # Redis 缓存
  redis:
    image: redis:7-alpine
    restart: always
    container_name: joysafeter-redis
    ports:
      - "${REDIS_PORT_HOST:-6379}:6379"
    volumes:
      - joysafeter-redis-data:/data
    env_file:
      - ../backend/.env
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
    networks:
      - joysafeter-network

  # 后端服务
  backend:
    image: ${DOCKER_REGISTRY:-docker.io/jdopensource}/${BACKEND_IMAGE:-joysafeter-backend}:${IMAGE_TAG:-latest}
    build:
      context: ../backend
      dockerfile: ../deploy/docker/backend.Dockerfile
      args:
        # 基础镜像源配置（可选，用于国内加速）
        # BASE_IMAGE_REGISTRY: "swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/"
        # pip 镜像源配置（默认使用清华大学镜像源，可切换到国内镜像）
        PIP_INDEX_URL: ${PIP_INDEX_URL:-https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple}
        UV_INDEX_URL: ${UV_INDEX_URL:-https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple}
    container_name: joysafeter-backend
    restart: unless-stopped
    env_file:
      - ../backend/.env
      - ../frontend/.env
    environment:
      # Redis 连接 URL（Docker Compose 环境默认值）
      # 如果 backend/.env 中配置了 REDIS_URL，则使用 .env 中的值
      # 如果未配置，则使用默认值 redis://redis:6379/0
      - REDIS_URL=${REDIS_URL:-redis://redis:6379/0}
    ports:
      - "${BACKEND_PORT_HOST:-8000}:8000"
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      # 挂载日志目录（使用 Docker volume 避免权限问题）
      - backend-logs:/app/app/logs
      - backend-files:/app/data/files  # 文件存储 volume（持久化用户上传的文件）
      - /usr/bin/docker:/usr/bin/docker
      - /var/run/docker.sock:/var/run/docker.sock
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - joysafeter-network

  # 数据库初始化服务（一次性运行）
  db-init:
    build:
      context: ../backend
      dockerfile: ../deploy/docker/init.Dockerfile
      args:
        # 基础镜像源配置（可选，用于国内加速）
        # BASE_IMAGE_REGISTRY: "swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/"
        # pip 镜像源配置（默认使用清华大学镜像源，可切换到国内镜像）
        PIP_INDEX_URL: ${PIP_INDEX_URL:-https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple}
        UV_INDEX_URL: ${UV_INDEX_URL:-https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple}
    container_name: joysafeter-db-init
    depends_on:
      db:
        condition: service_healthy
    env_file:
      - ../backend/.env
    # 注意：数据库连接信息完全从 env_file (../backend/.env) 读取
    # 支持使用外部 PostgreSQL，只需在 backend/.env 中配置正确的 POSTGRES_HOST、POSTGRES_PORT 等
    # 如果使用外部数据库，需要注释掉上面的 depends_on: db 部分
    networks:
      - joysafeter-network
    profiles:
      - init  # 使用 profile 控制，默认不启动
    command: ["python", "/app/scripts/db/init-db.py"]

  # 前端服务
  frontend:
    # 使用 deploy.sh 构建的镜像（默认: docker.io/jdopensource/joysafeter-frontend:latest）
    # 如果镜像不存在，会使用 build 配置进行构建
    image: ${DOCKER_REGISTRY:-docker.io/jdopensource}/${FRONTEND_IMAGE:-joysafeter-frontend}:${IMAGE_TAG:-latest}
    build:
      context: ../frontend
      dockerfile: ../deploy/docker/frontend.Dockerfile
      args:
        # 基础镜像源配置（可选，用于国内加速）
        # BASE_IMAGE_REGISTRY: "swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/"
        NEXT_PUBLIC_API_URL: "http://${BACKEND_HOST:-localhost}:${BACKEND_PORT_HOST:-8000}"
    container_name: joysafeter-frontend
    restart: unless-stopped
    env_file:
      - ../frontend/.env
    ports:
      - "${FRONTEND_PORT_HOST:-3000}:3000"
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "${FRONTEND_URL}"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - joysafeter-network

  # MCP Server 服务
  mcpserver:
    build:
      context: ..
      dockerfile: ./deploy/docker/mcp.Dockerfile
      args:
        # 基础镜像源配置（可选，用于国内加速）
        # BASE_IMAGE_REGISTRY: "swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/"
        # pip 镜像源配置（默认使用清华大学镜像源，可切换到国内镜像）
        PIP_INDEX_URL: ${PIP_INDEX_URL:-https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple}
        UV_INDEX_URL: ${UV_INDEX_URL:-https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple}
        # apt 镜像源配置（可选，用于国内加速）
        # APT_MIRROR: "http://mirrors.huaweicloud.com/ubuntu"
    container_name: joysafeter-mcpserver
    restart: unless-stopped
    env_file:
      - ../backend/.env
    volumes:
      # 日志目录（持久化）
      - mcpserver-logs:/export/App/logs
      # Supervisor运行时目录
      - mcpserver-run:/export/App/run
      # 文件存储 volume（与 backend 共享，用于访问用户上传的文件）
      - backend-files:/app/data/files
    ports:
      # MCP HTTP/SSE服务端口映射（8001-8010）
      # 根据实际需要添加或移除端口映射
      # 格式: "宿主机端口:容器端口"
      - "${DEMO_MCP_SERVER_PORT:-8001}:${DEMO_MCP_SERVER_PORT:-8001}"
      - "${SCANNER_MCP_PORT:-8002}:${SCANNER_MCP_PORT:-8002}"
      - "${JEB_MCP_PORT:-8008}:${JEB_MCP_PORT:-8008}"
      - "${MCP_PORT_3:-8003}:${MCP_PORT_3:-8003}"
      - "${MCP_PORT_4:-8004}:${MCP_PORT_4:-8004}"
      - "${MCP_PORT_5:-8005}:${MCP_PORT_5:-8005}"
      # 如需更多端口，请添加更多映射行
    healthcheck:
      test: ["CMD", "supervisorctl", "-c", "/export/App/supervisor/supervisord.conf", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    networks:
      - joysafeter-network
    depends_on:
      db:
        condition: service_healthy


volumes:
  joysafeter-db-data:
    driver: local
  joysafeter-redis-data:
    driver: local
  backend-logs:
    driver: local
  backend-files:
    driver: local
    name: joysafeter-backend-files
  mcpserver-logs:
    driver: local
  mcpserver-run:
    driver: local

networks:
  joysafeter-network:
    driver: bridge
