# 生产环境 Docker Compose 配置
# 使用预构建的 Docker 镜像，适合云主机部署

services:
  # PostgreSQL 数据库
  db:
    image: postgres:15-alpine
    restart: always
    container_name: joysafeter-db
    volumes:
      - joysafeter-db-data:/var/lib/postgresql/data
    env_file:
      - ../backend/.env
    environment:
      - PGDATA=/var/lib/postgresql/data
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_DB=${POSTGRES_DB:-joysafeter}
    ports:
      - "${POSTGRES_PORT_HOST:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-joysafeter}"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s
    networks:
      - joysafeter-network

  # Redis 缓存
  redis:
    image: redis:7-alpine
    restart: always
    container_name: joysafeter-redis
    ports:
      - "${REDIS_PORT_HOST:-6379}:6379"
    volumes:
      - joysafeter-redis-data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
    networks:
      - joysafeter-network

  # 后端服务（使用预构建镜像）
  # 镜像名称格式: ${DOCKER_REGISTRY}/${BACKEND_IMAGE}:${IMAGE_TAG}
  # 默认: docker.io/jdopensource/joysafeter-backend:latest
  backend:
    image: ${DOCKER_REGISTRY:-docker.io/jdopensource}/${BACKEND_IMAGE:-joysafeter-backend}:${IMAGE_TAG:-latest}
    container_name: joysafeter-backend
    restart: unless-stopped
    env_file:
      - ../backend/.env
    environment:
      # Redis 连接 URL（Docker Compose 环境默认值）
      # 如果 backend/.env 中配置了 REDIS_URL，则使用 .env 中的值
      # 如果未配置，则使用默认值 redis://redis:6379/0
      - REDIS_URL=${REDIS_URL:-redis://redis:6379/0}
    ports:
      - "${BACKEND_PORT_HOST:-8000}:8000"
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      # 挂载日志目录（可选，生产环境可以注释掉使用容器内日志）
      - backend-logs:/app/app/logs
      # 文件存储 volume（持久化用户上传的文件）
      - backend-files:/app/data/files
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - joysafeter-network

  # 前端服务（使用预构建镜像）
  # 镜像名称格式: ${DOCKER_REGISTRY}/${FRONTEND_IMAGE}:${IMAGE_TAG}
  # 默认: docker.io/jdopensource/joysafeter-frontend:latest
  frontend:
    image: ${DOCKER_REGISTRY:-docker.io/jdopensource}/${FRONTEND_IMAGE:-joysafeter-frontend}:${IMAGE_TAG:-latest}
    container_name: joysafeter-frontend
    restart: unless-stopped
    environment:
      # Node 环境
      - NODE_ENV=production
      - NEXT_TELEMETRY_DISABLED=1
    ports:
      - "${FRONTEND_PORT_HOST:-3000}:3000"
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - joysafeter-network

  # MCP Server 服务（使用预构建镜像）
  # 镜像名称格式: ${DOCKER_REGISTRY}/${MCP_IMAGE}:${IMAGE_TAG}
  # 默认: docker.io/jdopensource/joysafeter-mcp:latest
  mcpserver:
    image: docker.io/jdopensource/joysafeter-mcp:latest
    container_name: joysafeter-mcpserver
    restart: unless-stopped
    env_file:
      - ../backend/.env
    volumes:
      # 日志目录（持久化）
      - mcpserver-logs:/export/App/logs
      # Supervisor运行时目录
      - mcpserver-run:/export/App/run
      # 文件存储 volume（与 backend 共享，用于访问用户上传的文件）
      - backend-files:/app/data/files
    ports:
      # MCP HTTP/SSE服务端口映射（8001-8010）
      # 根据实际需要添加或移除端口映射
      # 格式: "宿主机端口:容器端口"
      - "${DEMO_MCP_SERVER_PORT:-8001}:${DEMO_MCP_SERVER_PORT:-8001}"
      - "${SCANNER_MCP_PORT:-8002}:${SCANNER_MCP_PORT:-8002}"
      - "${JEB_MCP_PORT:-8008}:${JEB_MCP_PORT:-8008}"
      - "${MCP_PORT_3:-8003}:${MCP_PORT_3:-8003}"
      - "${MCP_PORT_4:-8004}:${MCP_PORT_4:-8004}"
      - "${MCP_PORT_5:-8005}:${MCP_PORT_5:-8005}"
      # 如需更多端口，请添加更多映射行
    healthcheck:
      test: ["CMD", "supervisorctl", "-c", "/export/App/supervisor/supervisord.conf", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    networks:
      - joysafeter-network
    depends_on:
      db:
        condition: service_healthy
    profiles:
      # 使用profile控制，默认不启动（需要时添加 --profile mcpserver）
      - mcpserver

volumes:
  joysafeter-db-data:
    driver: local
  joysafeter-redis-data:
    driver: local
  backend-logs:
    driver: local
  backend-files:
    driver: local
    name: joysafeter-backend-files

networks:
  joysafeter-network:
    driver: bridge
