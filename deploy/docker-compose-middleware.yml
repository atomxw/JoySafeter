# 中间件 Docker Compose 配置
# 仅包含 PostgreSQL、Redis 和数据库初始化服务
# 适用于本地开发环境
#
# 环境变量说明：
# - 统一从 backend/.env 加载配置，保持与应用配置一致
# - environment 部分用于覆盖容器间通信必需的参数
# - POSTGRES_PASSWORD 仅在数据库首次初始化时生效，修改后需重置密码或删除 Volume

services:
  # PostgreSQL 数据库
  # 注意：环境变量完全从 backend/.env 加载，不再使用 ${VAR:-default} 语法
  # 因为 ${VAR} 查找的是宿主机环境变量，而非 env_file 中的变量
  db:
    image: ${DB_IMAGE:-swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/library/postgres:15}
    restart: always
    container_name: joysafeter-db
    volumes:
      - joysafeter-db-data:/var/lib/postgresql/data
    env_file:
      - ../backend/.env
    environment:
      # PostgreSQL 镜像固定配置
      PGDATA: /var/lib/postgresql/data
      # 不再覆盖 POSTGRES_USER/PASSWORD/DB，完全使用 env_file 中的值
    ports:
      - "${POSTGRES_PORT_HOST:-5432}:5432"
    healthcheck:
      # 使用 $$ 转义语法，让环境变量在容器内部 shell 中展开
      # 这样可以正确读取 env_file 中的 POSTGRES_USER 和 POSTGRES_DB
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s
    networks:
      - joysafeter-network

  # Redis 缓存
  redis:
    image: ${REDIS_IMAGE:-swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/redis:alpine3.22}
    restart: always
    container_name: joysafeter-redis
    ports:
      - "${REDIS_PORT_HOST:-6379}:6379"
    volumes:
      - joysafeter-redis-data:/data
    env_file:
      - ../backend/.env
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
    networks:
      - joysafeter-network

  # 数据库初始化服务（一次性运行）
  # 使用: docker-compose -f docker-compose-middleware.yml --profile init run --rm db-init
  db-init:
    build:
      context: ../backend
      dockerfile: ../deploy/docker/init.Dockerfile
      args:
        # 基础镜像源配置（可选，用于国内加速）
        # BASE_IMAGE_REGISTRY: "swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/"
        # pip 镜像源配置（默认使用清华大学镜像源，可切换到国内镜像）
        PIP_INDEX_URL: ${PIP_INDEX_URL:-https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple}
        UV_INDEX_URL: ${UV_INDEX_URL:-https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple}
    container_name: joysafeter-db-init
    depends_on:
      db:
        condition: service_healthy
    env_file:
      - ../backend/.env
    environment:
      # 仅覆盖容器间通信必需的参数
      # 关键：POSTGRES_HOST 必须为 "db"（服务名），而非 localhost
      # 关键：POSTGRES_PORT 必须为 5432（容器内部端口），而非宿主机映射端口
      # 其他参数（USER/PASSWORD/DB）从 env_file 继承，不再使用 ${VAR:-default} 语法
      POSTGRES_HOST: db
      POSTGRES_PORT: "5432"
    networks:
      - joysafeter-network
    profiles:
      - init  # 使用 profile 控制，默认不启动
    command: ["python", "scripts/db/init-db.py"]

  # MCP Server 服务
  mcpserver:
    build:
      context: ..
      dockerfile: ./deploy/docker/mcp.Dockerfile
      args:
        # 基础镜像源配置（可选，用于国内加速）
        # BASE_IMAGE_REGISTRY: "swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/"
        # pip 镜像源配置（默认使用清华大学镜像源，可切换到国内镜像）
        PIP_INDEX_URL: ${PIP_INDEX_URL:-https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple}
        UV_INDEX_URL: ${UV_INDEX_URL:-https://mirrors.tuna.tsinghua.edu.cn/pypi/web/simple}
        # apt 镜像源配置（可选，用于国内加速）
        # APT_MIRROR: "http://mirrors.huaweicloud.com/ubuntu"
    container_name: joysafeter-mcpserver
    restart: unless-stopped
    env_file:
      - ../backend/.env
    volumes:
      # 日志目录（持久化）
      - mcpserver-logs:/export/App/logs
      # Supervisor运行时目录
      - mcpserver-run:/export/App/run
      # 文件存储 volume（与 backend 共享，用于访问用户上传的文件）
      - backend-files:/app/data/files
    ports:
      # MCP HTTP/SSE服务端口映射（8001-8010）
      # 根据实际需要添加或移除端口映射
      # 格式: "宿主机端口:容器端口"
      - "${DEMO_MCP_SERVER_PORT:-8001}:${DEMO_MCP_SERVER_PORT:-8001}"
      - "${SCANNER_MCP_PORT:-8002}:${SCANNER_MCP_PORT:-8002}"
      - "${JEB_MCP_PORT:-8008}:${JEB_MCP_PORT:-8008}"
      - "${MCP_PORT_3:-8003}:${MCP_PORT_3:-8003}"
      - "${MCP_PORT_4:-8004}:${MCP_PORT_4:-8004}"
      - "${MCP_PORT_5:-8005}:${MCP_PORT_5:-8005}"
      # 如需更多端口，请添加更多映射行
    healthcheck:
      test: ["CMD", "supervisorctl", "-c", "/export/App/supervisor/supervisord.conf", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    networks:
      - joysafeter-network
    depends_on:
      db:
        condition: service_healthy

volumes:
  joysafeter-db-data:
    driver: local
  joysafeter-redis-data:
    driver: local
  mcpserver-logs:
    driver: local
  mcpserver-run:
    driver: local
  backend-files:
    driver: local
    name: joysafeter-backend-files

networks:
  joysafeter-network:
    driver: bridge
