# åŠŸèƒ½æ“ä½œæµç¨‹è¯¦ç»†è¯´æ˜

## ä¸€ã€Router èŠ‚ç‚¹å®Œæ•´æµç¨‹

### 1.1 åˆ›å»º Router èŠ‚ç‚¹
```
ç”¨æˆ·æ“ä½œï¼š
1. ä»ä¾§è¾¹æ æ‹–æ‹½ Router èŠ‚ç‚¹åˆ°ç”»å¸ƒ
2. èŠ‚ç‚¹è‡ªåŠ¨åˆ›å»ºï¼Œä½¿ç”¨é»˜è®¤é…ç½®ï¼ˆ2ä¸ªç¤ºä¾‹è·¯ç”±è§„åˆ™ï¼‰

æ•°æ®çŠ¶æ€ï¼š
- nodes: æ–°å¢ router_node èŠ‚ç‚¹
- èŠ‚ç‚¹ config.routes: åŒ…å« 2 ä¸ªé»˜è®¤ RouteRule
- èŠ‚ç‚¹ config.defaultRoute: 'default'
```

### 1.2 é…ç½®è·¯ç”±è§„åˆ™
```
ç”¨æˆ·æ“ä½œï¼š
1. ç‚¹å‡» Router èŠ‚ç‚¹ â†’ æ‰“å¼€ PropertiesPanel
2. åœ¨ "Route Rules" å­—æ®µä¸­ï¼š
   a. æŸ¥çœ‹ç°æœ‰è§„åˆ™åˆ—è¡¨ï¼ˆå¯æ‹–æ‹½æ’åºï¼‰
   b. ç‚¹å‡» "Add Route Rule" æ·»åŠ æ–°è§„åˆ™
   c. ä¸ºæ¯ä¸ªè§„åˆ™é…ç½®ï¼š
      - Condition: è¾“å…¥ Python è¡¨è¾¾å¼ï¼ˆä½¿ç”¨ ConditionExprFieldï¼Œå¸¦è¯­æ³•é«˜äº®ï¼‰
      - Target Edge: ä»ä¸‹æ‹‰é€‰æ‹©ç›®æ ‡è¾¹ï¼ˆæ˜¾ç¤º route_key å’Œç›®æ ‡èŠ‚ç‚¹ï¼‰
      - Label: è¾“å…¥è§„åˆ™æ ‡ç­¾
   d. æ‹–æ‹½è§„åˆ™é¡¹è°ƒæ•´ä¼˜å…ˆçº§ï¼ˆæ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼‰
   e. åˆ é™¤ä¸éœ€è¦çš„è§„åˆ™
3. é…ç½® "Default Route Key"ï¼ˆå½“æ‰€æœ‰æ¡ä»¶éƒ½ä¸åŒ¹é…æ—¶ä½¿ç”¨ï¼‰

æ•°æ®æµï¼š
RouteListField.onChange
  â†’ PropertiesPanel.updateConfig
  â†’ BuilderStore.updateNodeConfig
  â†’ BuilderStore.syncEdgesWithRouteRules (è‡ªåŠ¨åŒæ­¥è¾¹æ•°æ®)
  â†’ æ›´æ–°ç›¸å…³è¾¹çš„ route_key
  â†’ triggerAutoSave â†’ åç«¯ä¿å­˜
```

### 1.3 åˆ›å»ºè¾¹å¹¶å…³è”è·¯ç”±
```
ç”¨æˆ·æ“ä½œï¼š
1. ä» Router èŠ‚ç‚¹æ‹–æ‹½åˆ›å»ºè¾¹åˆ°ç›®æ ‡èŠ‚ç‚¹
2. onConnect è‡ªåŠ¨æ‰§è¡Œï¼š
   - æ£€æµ‹æºèŠ‚ç‚¹æ˜¯ router_node
   - è‡ªåŠ¨è®¾ç½® edge_type = 'conditional'
   - æ™ºèƒ½è®¾ç½® route_keyï¼ˆä» routes ä¸­é€‰æ‹©æœªä½¿ç”¨çš„ï¼‰
3. ç‚¹å‡»è¾¹ â†’ æ‰“å¼€ EdgePropertiesPanel
4. ç¡®è®¤/ä¿®æ”¹ route_keyï¼ˆåº”è¯¥ä¸è·¯ç”±è§„åˆ™ä¸­çš„ targetEdgeKey åŒ¹é…ï¼‰
5. å¯é€‰ï¼šè®¾ç½® labelã€source_handle_id

éªŒè¯ï¼š
- å®æ—¶éªŒè¯ route_key æ˜¯å¦ä¸è·¯ç”±è§„åˆ™åŒ¹é…
- å¦‚æœ route_key ä¸å­˜åœ¨äºä»»ä½•è·¯ç”±è§„åˆ™ä¸­ï¼Œæ˜¾ç¤ºè­¦å‘Š
- å¦‚æœå¤šä¸ªè¾¹ä½¿ç”¨ç›¸åŒçš„ route_keyï¼Œæ˜¾ç¤ºè­¦å‘Š
```

### 1.4 æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥
```
è‡ªåŠ¨æ£€æŸ¥ï¼š
1. æ¯ä¸ªè·¯ç”±è§„åˆ™çš„ targetEdgeKey å¿…é¡»å¯¹åº”ä¸€ä¸ªè¾¹çš„ route_key
2. å¦‚æœè§„åˆ™æŒ‡å‘çš„è¾¹ä¸å­˜åœ¨ï¼Œæ˜¾ç¤ºé”™è¯¯æç¤º
3. å¦‚æœè¾¹å­˜åœ¨ä½† route_key ä¸åŒ¹é…ï¼Œæ˜¾ç¤ºé”™è¯¯æç¤º
4. è§„åˆ™åˆ é™¤æ—¶ï¼Œè‡ªåŠ¨æ¸…ç†ç›¸å…³è¾¹çš„ route_key
```

## äºŒã€Loop Condition èŠ‚ç‚¹å®Œæ•´æµç¨‹

### 2.1 åˆ›å»º Loop Condition èŠ‚ç‚¹
```
ç”¨æˆ·æ“ä½œï¼š
1. æ‹–æ‹½ Loop Condition èŠ‚ç‚¹åˆ°ç”»å¸ƒ
2. èŠ‚ç‚¹åˆ›å»ºï¼Œé»˜è®¤é…ç½®ï¼š
   - conditionType: 'while'
   - listVariable: 'items'
   - condition: 'loop_count < 3'
   - maxIterations: 5
```

### 2.2 é…ç½®å¾ªç¯ç±»å‹
```
ç”¨æˆ·æ“ä½œï¼š
1. æ‰“å¼€ PropertiesPanel
2. é€‰æ‹© Loop Typeï¼š
   - forEach: éå†åˆ—è¡¨
   - while: å…ˆæ£€æŸ¥æ¡ä»¶å†æ‰§è¡Œ
   - doWhile: å…ˆæ‰§è¡Œå†æ£€æŸ¥æ¡ä»¶

æ ¹æ®ç±»å‹æ˜¾ç¤ºä¸åŒå­—æ®µï¼š
- forEach: æ˜¾ç¤º listVariable å­—æ®µ
- while/doWhile: æ˜¾ç¤º condition å­—æ®µï¼ˆä½¿ç”¨ ConditionExprFieldï¼‰
```

### 2.3 é…ç½®å¾ªç¯æ¡ä»¶
```
ç”¨æˆ·æ“ä½œï¼š
1. å¦‚æœé€‰æ‹© forEachï¼š
   - è¾“å…¥ listVariableï¼ˆå¦‚ 'items'ï¼‰
   - ç³»ç»Ÿä¼šä» state[listVariable] è·å–åˆ—è¡¨è¿›è¡Œéå†
2. å¦‚æœé€‰æ‹© while/doWhileï¼š
   - åœ¨ Condition å­—æ®µè¾“å…¥ Python è¡¨è¾¾å¼
   - ä½¿ç”¨ ConditionExprFieldï¼ˆè¯­æ³•é«˜äº®ã€å˜é‡æç¤ºï¼‰
   - è¡¨è¾¾å¼åº”è¿”å›å¸ƒå°”å€¼
3. è®¾ç½® maxIterationsï¼ˆ1-100ï¼Œé˜²æ­¢æ— é™å¾ªç¯ï¼‰

éªŒè¯ï¼š
- condition è¡¨è¾¾å¼è¯­æ³•æ£€æŸ¥ï¼ˆæ‹¬å·ã€æ‹¬å·ã€å¤§æ‹¬å·å¹³è¡¡ï¼‰
- maxIterations èŒƒå›´éªŒè¯
```

## ä¸‰ã€Condition èŠ‚ç‚¹å®Œæ•´æµç¨‹

### 3.1 åˆ›å»º Condition èŠ‚ç‚¹
```
ç”¨æˆ·æ“ä½œï¼š
1. æ‹–æ‹½ Condition èŠ‚ç‚¹åˆ°ç”»å¸ƒ
2. é»˜è®¤é…ç½®ï¼š
   - expression: ''
   - trueLabel: 'Yes'
   - falseLabel: 'No'
```

### 3.2 é…ç½®æ¡ä»¶è¡¨è¾¾å¼
```
ç”¨æˆ·æ“ä½œï¼š
1. æ‰“å¼€ PropertiesPanel
2. åœ¨ "Condition Expression" å­—æ®µï¼š
   - ä½¿ç”¨ ConditionExprField è¾“å…¥ Python è¡¨è¾¾å¼
   - æ”¯æŒè¯­æ³•é«˜äº®ï¼ˆPythonï¼‰
   - æ”¯æŒå˜é‡è‡ªåŠ¨è¡¥å…¨ï¼ˆå¦‚æœæä¾› nodes/edgesï¼‰
   - å®æ—¶è¯­æ³•æ£€æŸ¥
3. é…ç½®åˆ†æ”¯æ ‡ç­¾ï¼š
   - True Branch Label: 'Yes'ï¼ˆTrue åˆ†æ”¯çš„æ˜¾ç¤ºæ ‡ç­¾ï¼‰
   - False Branch Label: 'No'ï¼ˆFalse åˆ†æ”¯çš„æ˜¾ç¤ºæ ‡ç­¾ï¼‰

éªŒè¯ï¼š
- è¡¨è¾¾å¼è¯­æ³•æ£€æŸ¥
- å˜é‡å¼•ç”¨éªŒè¯ï¼ˆå¦‚æœå¯ç”¨ï¼‰
```

### 3.3 åˆ›å»ºæ¡ä»¶è¾¹
```
ç”¨æˆ·æ“ä½œï¼š
1. ä» Condition èŠ‚ç‚¹åˆ›å»ºä¸¤æ¡è¾¹ï¼š
   - ç¬¬ä¸€æ¡è¾¹ï¼šè‡ªåŠ¨è®¾ç½® route_key = 'true'
   - ç¬¬äºŒæ¡è¾¹ï¼šè‡ªåŠ¨è®¾ç½® route_key = 'false'
2. ç‚¹å‡»è¾¹é…ç½®ï¼š
   - ç¡®è®¤ route_key æ­£ç¡®
   - å¯é€‰ï¼šè®¾ç½® labelï¼ˆä½¿ç”¨ trueLabel/falseLabelï¼‰
```

## å››ã€è¾¹é…ç½®å®Œæ•´æµç¨‹

### 4.1 åˆ›å»ºè¾¹
```
ç”¨æˆ·æ“ä½œï¼š
1. ä»æºèŠ‚ç‚¹æ‹–æ‹½åˆ°ç›®æ ‡èŠ‚ç‚¹åˆ›å»ºè¾¹
2. ç³»ç»Ÿè‡ªåŠ¨ï¼š
   - æ£€æµ‹æºèŠ‚ç‚¹ç±»å‹
   - è®¾ç½® edge_typeï¼ˆrouter/condition/loop_condition_node â†’ 'conditional'ï¼Œå…¶ä»– â†’ 'normal'ï¼‰
   - æ™ºèƒ½è®¾ç½® route_keyï¼ˆå¦‚æœé€‚ç”¨ï¼‰ï¼š
     * router_node: ä» routes ä¸­é€‰æ‹©æœªä½¿ç”¨çš„
     * condition: 'true' æˆ– 'false'ï¼ˆä¼˜å…ˆ 'true'ï¼‰
     * loop_condition_node: 'continue_loop' æˆ– 'exit_loop'ï¼ˆä¼˜å…ˆ 'continue_loop'ï¼‰
```

### 4.2 é…ç½®è¾¹å±æ€§
```
ç”¨æˆ·æ“ä½œï¼š
1. ç‚¹å‡»è¾¹ â†’ æ‰“å¼€ EdgePropertiesPanel
2. é…ç½® Edge Typeï¼š
   - Normal: æ™®é€šè¿æ¥
   - Conditional: æ¡ä»¶è·¯ç”±
   - Loop Back: å¾ªç¯å›è¾¹
3. å¦‚æœæ˜¯ Conditional è¾¹ï¼š
   - é…ç½® Route Keyï¼ˆå¿…é¡»ä¸æºèŠ‚ç‚¹çš„è·¯ç”±è§„åˆ™åŒ¹é…ï¼‰
   - å¯é€‰ï¼šSource Handle ID
   - æ˜¾ç¤º Quick Select æŒ‰é’®ï¼ˆå¿«é€Ÿé€‰æ‹©å»ºè®®çš„ route_keyï¼‰
4. é…ç½® Labelï¼ˆå¯é€‰ï¼Œæ˜¾ç¤ºåœ¨è¾¹ä¸Šçš„æ ‡ç­¾ï¼‰

éªŒè¯ï¼š
- å®æ—¶éªŒè¯ route_key æ ¼å¼
- éªŒè¯ route_key ä¸æºèŠ‚ç‚¹è·¯ç”±è§„åˆ™çš„åŒ¹é…
- éªŒè¯è¾¹ç±»å‹ä¸æºèŠ‚ç‚¹ç±»å‹çš„ä¸€è‡´æ€§
```

## äº”ã€æ•°æ®åŒæ­¥æµç¨‹

### 5.1 è·¯ç”±è§„åˆ™å˜åŒ–æ—¶çš„è‡ªåŠ¨åŒæ­¥
```
è§¦å‘æ—¶æœºï¼š
- ç”¨æˆ·ä¿®æ”¹ router_node çš„ routes é…ç½®
- ç”¨æˆ·åˆ é™¤è·¯ç”±è§„åˆ™
- ç”¨æˆ·æ·»åŠ è·¯ç”±è§„åˆ™

è‡ªåŠ¨æ‰§è¡Œï¼š
1. syncEdgesWithRouteRules è¢«è°ƒç”¨
2. æŸ¥æ‰¾æ‰€æœ‰ä»è¯¥èŠ‚ç‚¹å‡ºå‘çš„è¾¹
3. å¯¹äºæ¯æ¡è¾¹ï¼š
   - å¦‚æœ route_key åœ¨ routes ä¸­ï¼šä¿æŒä¸å˜
   - å¦‚æœ route_key ä¸åœ¨ routes ä¸­ï¼šæ¸…é™¤ route_key
   - å¦‚æœæ˜¯ conditional è¾¹ä½†æ²¡æœ‰ route_keyï¼šå°è¯•åŒ¹é…æœªä½¿ç”¨çš„è·¯ç”±
4. æ›´æ–°è¾¹æ•°æ®
5. è§¦å‘è‡ªåŠ¨ä¿å­˜
```

### 5.2 è¾¹åˆ é™¤æ—¶çš„å¤„ç†
```
ç”¨æˆ·æ“ä½œï¼š
1. åˆ é™¤è¾¹

ç³»ç»Ÿå¤„ç†ï¼š
- è¾¹ä» edges æ•°ç»„ä¸­ç§»é™¤
- å¦‚æœè¯¥è¾¹æœ‰ route_keyï¼Œç›¸å…³è·¯ç”±è§„åˆ™ä¼šæ˜¾ç¤ºè­¦å‘Šï¼ˆè¾¹ä¸å­˜åœ¨ï¼‰
- ç”¨æˆ·éœ€è¦ï¼š
  a. åˆ é™¤å¯¹åº”çš„è·¯ç”±è§„åˆ™ï¼Œæˆ–
  b. åˆ›å»ºæ–°çš„è¾¹å¹¶è®¾ç½®ç›¸åŒçš„ route_key
```

## å…­ã€éªŒè¯æµç¨‹

### 6.1 å®æ—¶éªŒè¯
```
éªŒè¯æ—¶æœºï¼š
1. è¾“å…¥æ—¶ï¼ˆdebouncedï¼Œ300msï¼‰
2. å¤±å»ç„¦ç‚¹æ—¶
3. ä¿å­˜å‰

éªŒè¯ä½ç½®ï¼š
1. RouteListField: æ¯ä¸ªè§„åˆ™çš„æ¡ä»¶è¡¨è¾¾å¼å’Œç›®æ ‡è¾¹
2. ConditionExprField: è¡¨è¾¾å¼è¯­æ³•
3. EdgePropertiesPanel: è¾¹æ•°æ®å®Œæ•´æ€§
4. PropertiesPanel: èŠ‚ç‚¹é…ç½®å®Œæ•´æ€§

éªŒè¯ç»“æœï¼š
- é”™è¯¯ï¼ˆçº¢è‰²ï¼‰ï¼šé˜»æ­¢ä¿å­˜
- è­¦å‘Šï¼ˆé»„è‰²ï¼‰ï¼šå…è®¸ä¿å­˜ä½†æç¤ºç”¨æˆ·
- æˆåŠŸï¼ˆç»¿è‰²ï¼‰ï¼šé…ç½®æœ‰æ•ˆ
```

### 6.2 æ‰¹é‡éªŒè¯
```
éªŒè¯æ—¶æœºï¼š
- ä¿å­˜å›¾æ—¶
- éƒ¨ç½²å›¾æ—¶

éªŒè¯å†…å®¹ï¼š
- æ‰€æœ‰è·¯ç”±è§„åˆ™ä¸è¾¹çš„åŒ¹é…
- æ‰€æœ‰è¾¹çš„æ•°æ®å®Œæ•´æ€§
- å›¾çš„æ•´ä½“ä¸€è‡´æ€§

éªŒè¯ç»“æœï¼š
- å¦‚æœæœ‰é”™è¯¯ï¼Œé˜»æ­¢ä¿å­˜/éƒ¨ç½²
- æ˜¾ç¤ºæ‰€æœ‰é”™è¯¯å’Œè­¦å‘Š
```

## ä¸ƒã€å¾…å®Œå–„é¡¹æ€»ç»“

### âœ… å·²ä¿®å¤ï¼ˆP0ï¼‰
1. âœ… nodeConfigValidator.ts - æ”¯æŒæ–°æ—§æ ¼å¼
2. âœ… nodeConfigTemplates.ts - ä½¿ç”¨æ–°æ ¼å¼
3. âœ… syncEdgesWithRouteRules - å®ç°æ­£ç¡®åŒ¹é…é€»è¾‘
4. âœ… onConnect - æ™ºèƒ½è®¾ç½®é»˜è®¤ route_key

### ğŸ”„ å¾…ä¼˜åŒ–ï¼ˆP1ï¼‰
1. **æ•°æ®è¿ç§»** - åŠ è½½æ—§å›¾æ—¶è‡ªåŠ¨è½¬æ¢æ ¼å¼
2. **éªŒè¯ç»Ÿä¸€** - ç»Ÿä¸€æ‰€æœ‰éªŒè¯æ—¶æœºå’Œé”™è¯¯æ˜¾ç¤ºä½ç½®
3. **RouteListField è¾¹åˆ›å»º** - åœ¨é…ç½®è§„åˆ™æ—¶æä¾›åˆ›å»ºè¾¹çš„å¿«æ·æ“ä½œ

### ğŸ’¡ å¯æ”¹è¿›ï¼ˆP2ï¼‰
1. **EdgePropertiesPanel æ˜¾ç¤ºä¼˜åŒ–** - æ ¹æ®è¾¹ç±»å‹æ˜¾ç¤ºä¸åŒå†…å®¹
2. **ConditionExprField ç»Ÿä¸€** - ç»Ÿä¸€ä¸¤ç§å®ç°è·¯å¾„çš„ UI
3. **æ€§èƒ½ä¼˜åŒ–** - æ·»åŠ é˜²æŠ–ï¼Œå‡å°‘ä¸å¿…è¦çš„æ›´æ–°

## å…«ã€è¿å’Œç‚¹æ€»ç»“

### 8.1 å·²è§£å†³
- âœ… å­—æ®µå‘½åä¸ä¸€è‡´ï¼ˆéªŒè¯å™¨å’Œæ¨¡æ¿å·²æ›´æ–°ï¼‰
- âœ… è‡ªåŠ¨åŒæ­¥é€»è¾‘ä¸å®Œå–„ï¼ˆå·²å®ç°æ­£ç¡®åŒ¹é…ï¼‰

### 8.2 ä»éœ€æ”¹è¿›
1. **éªŒè¯æ—¶æœºä¸ä¸€è‡´** - æœ‰äº›åœ°æ–¹é˜»æ­¢ä¿å­˜ï¼Œæœ‰äº›åªè­¦å‘Š
2. **é”™è¯¯æç¤ºä½ç½®ä¸ç»Ÿä¸€** - ä¸åŒç»„ä»¶åœ¨ä¸åŒä½ç½®æ˜¾ç¤ºé”™è¯¯
3. **UI é£æ ¼ç»†å¾®å·®å¼‚** - RouteListField å’Œ ConditionExprField çš„æ ·å¼å¯ä»¥æ›´ç»Ÿä¸€
4. **è¾¹ç±»å‹è‡ªåŠ¨æ›´æ–°ç¼ºå¤±** - æºèŠ‚ç‚¹ç±»å‹å˜åŒ–æ—¶ï¼Œè¾¹çš„ edge_type ä¸ä¼šè‡ªåŠ¨æ›´æ–°

