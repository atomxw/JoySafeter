import os
from typing import Any, Dict
import logging

from dynamic_engine.mcp.handler import AbstractHandler, HandlerType
from dynamic_engine.runtime.command.command_executor import execute_command

logger = logging.getLogger(__name__)


class PacuHandler(AbstractHandler):
    """Handler for pacu functionality"""
    
    def type(self) -> HandlerType:
        return HandlerType.PYTHON

    def commands(self) -> list:
        '''Handler related commands'''
        return ['pacu']
    
    def handle(self, data: Dict) -> Any:
        """Execute pacu with enhanced logging"""
        try:
            session_name = data.get("session_name", "hexstrike_session")
            modules = data.get("modules", "")
            data_services = data.get("data_services", "")
            regions = data.get("regions", "")
            additional_args = data.get("additional_args", "")
            commands = []
            commands.append(f"set_session {session_name}")
            if data_services:
                commands.append(f"data {data_services}")
            if regions:
                commands.append(f"set_regions {regions}")
            if modules:
                for module in modules.split(","):
                    commands.append(f"run {module.strip()}")
            commands.append("exit")
            command_file = "/tmp/pacu_commands.txt"
            with open(command_file, "w") as f:
                f.write("\n".join(commands))
            command = f"pacu < {command_file}"
            if additional_args:
                command += f" {additional_args}"
            logger.info(f"â˜ï¸  Starting Pacu AWS exploitation")
            result = execute_command(command)
            try:
                os.remove(command_file)
            except:
                pass
            logger.info(f"ðŸ“Š Pacu exploitation completed")
            return result
        except Exception as e:
            logger.error(f"ðŸ’¥ Error in pacu endpoint: {str(e)}")
            return {"error": f"Server error: {str(e)}"}
