import logging
import os
from typing import Any, Dict

from dynamic_engine.mcp.handler import AbstractHandler, HandlerType
from dynamic_engine.runtime.command.command_executor import execute_command

logger = logging.getLogger(__name__)



class PwntoolsHandler(AbstractHandler):
    """Handler for pwntools functionality"""
    
    def type(self) -> HandlerType:
        return HandlerType.PYTHON

    def commands(self) -> list:
        '''Handler related commands'''
        return ['python3']
    
    def handle(self, data: Dict) -> Any:
        """Execute pwntools with enhanced logging"""
        try:
            script_content = data.get("script_content", "")
            target_binary = data.get("target_binary", "")
            target_host = data.get("target_host", "")
            target_port = data.get("target_port", 0)
            exploit_type = data.get("exploit_type", "local")  # local, remote, format_string, rop
            additional_args = data.get("additional_args", "")

            if not script_content and not target_binary:
                logger.warning("ðŸ”§ Pwntools called without script content or target binary")
                return {"error": "Script content or target binary is required"}

            # Create temporary Python script
            script_file = "/tmp/pwntools_exploit.py"

            if script_content:
                # Use provided script content
                with open(script_file, "w") as f:
                    f.write(script_content)
            else:
                # Generate basic exploit template
                template = f"""#!/usr/bin/env python3
        from pwn import *

        # Configuration
        context.arch = 'amd64'
        context.os = 'linux'
        context.log_level = 'info'

        # Target configuration
        binary = '{target_binary}' if '{target_binary}' else None
        host = '{target_host}' if '{target_host}' else None
        port = {target_port} if {target_port} else None

        # Exploit logic
        if binary:
            p = process(binary)
            log.info(f"Started local process: {{binary}}")
        elif host and port:
            p = remote(host, port)
            log.info(f"Connected to {{host}}:{{port}}")
        else:
            log.error("No target specified")
            exit(1)

        # Basic interaction
        p.interactive()
        """
                with open(script_file, "w") as f:
                    f.write(template)

            command = f"python3 {script_file}"

            if additional_args:
                command += f" {additional_args}"

            logger.info(f"ðŸ”§ Starting Pwntools exploit: {exploit_type}")
            result = execute_command(command)

            # Cleanup
            # todo
            try:
                os.remove(script_file)
            except:
                pass

            return result
        except Exception as e:
            logger.error(f"ðŸ’¥ Error in pwntools endpoint: {str(e)}")
            return {"error": f"Server error: {str(e)}"}
