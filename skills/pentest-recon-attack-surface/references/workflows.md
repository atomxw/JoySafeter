# Workflows

## Attack Surface Mapping Patterns

## AI-assisted selection

1. Run technology fingerprinting to identify framework and stack.
2. Execute external scans and correlate with deployment configs.
3. Perform authenticated browser exploration at each privilege level.
4. Extract routes from source code and map authorization middleware.
5. Synthesize endpoint inventory, role architecture, and authz candidates.

---

## external_scan

Correlate network scan results with deployment configuration to identify exposure gaps.

- nmap_service_scan: flags ["-sV", "-sC"], timing 3
- subfinder_enumerate: recursive False
- test_vectors:
  - Compare nmap open ports vs docker-compose exposed ports
  - Identify services in deployment configs not exposed externally (internal-only)
  - Identify externally exposed services not in deployment configs (shadow services)
  - Cross-reference subdomain enumeration with DNS records and cloud provider configs
  - Check for development/staging services accidentally exposed to production

## interactive_exploration

Authenticated browser crawl at each privilege level to capture dynamic endpoints.

- playwright_authenticated_crawl: depth 5, capture_xhr True, capture_websocket True
- test_vectors:
  - Crawl as anonymous user — record all accessible endpoints
  - Crawl as regular user — record endpoints requiring authentication
  - Crawl as admin — record admin-only endpoints and UI elements
  - Diff endpoint sets across privilege levels to identify authz boundaries
  - Capture WebSocket handshakes and message patterns
  - Record all form submissions with parameter names and types

## code_correlation

Extract route definitions from source code and map to observed endpoints.

- semgrep_route_extract: framework auto-detect
- ripgrep_pattern: pattern "router\.(get|post|put|delete|patch|all)" for Express
- test_vectors:
  - Extract all route definitions with file:line pointers
  - Map each route to its handler function
  - Identify routes present in code but not observed during crawl (hidden endpoints)
  - Identify crawl-observed endpoints not matching any route definition (dynamic routes)
  - Extract path parameter patterns and query parameter expectations

## endpoint_inventory

Build structured endpoint inventory table from all data sources.

- validation:
  - Every route from source code has a row in the inventory
  - Every observed endpoint from crawl is mapped to a source code route
  - Each row includes: method, path, auth_required, roles_allowed, validation_summary, file:line
  - Unmatched endpoints flagged for manual review
  - Parameters classified by type: path, query, body, header

## role_mapping

Synthesize role definitions and privilege architecture from source code.

- semgrep_route_extract: framework auto-detect
- ripgrep_pattern: pattern "role|permission|isAdmin|authorize|can\\("
- test_vectors:
  - Extract all role definitions (enum, constant, database seed)
  - Map permissions assigned to each role
  - Build privilege lattice showing role hierarchy
  - Identify role checks in middleware vs inline handler checks
  - Flag endpoints with no role check but accessing sensitive data
  - Trace session/token to role resolution logic

## prioritization

Rank authorization vulnerability candidates for downstream code review.

- validation:
  - Score each candidate by: missing auth middleware, inconsistent role checks, sensitive data access, user-controlled object references
  - Priority tiers: CRITICAL (no auth on sensitive endpoint), HIGH (inconsistent authz), MEDIUM (weak validation), LOW (informational)
  - Output format: JSON array of candidates with endpoint, vulnerability_type, confidence, evidence_file_line
  - Each candidate includes recommended next step (code review or direct exploitation)

## Reporting and validation

- Produce API Endpoint Inventory as structured table (method, path, auth, roles, validation, file:line)
- Produce Network Interaction Map showing external/internal service boundaries
- Produce Role & Privilege Architecture diagram data
- Produce prioritized Authorization Vulnerability Candidates list
- All findings include source code file:line references for traceability
