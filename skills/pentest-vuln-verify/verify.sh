#!/bin/bash

# verify.sh - Automated vulnerability verification using Curl
# Usage: ./verify.sh -u <url> [-c <cookie>] [-m <method>] [-d <data>] [-H <header>]

URL=""
COOKIE=""
METHOD="GET"
DATA=""
HEADERS=()
VERIFY_DOMAINS=("baidu.com" "taobao.com")
USER_AGENT="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"

function print_usage {
    echo "Usage: $0 -u <url> [-c <cookie>] [-m <method>] [-d <data>] [-H <header>]"
    exit 1
}

# Parse arguments
while [[ "$#" -gt 0 ]]; do
    case $1 in
        -u|--url) URL="$2"; shift ;;
        -c|--cookie) COOKIE="$2"; shift ;;
        -m|--method) METHOD="$2"; shift ;;
        -d|--data) DATA="$2"; shift ;;
        -A|--user-agent) USER_AGENT="$2"; shift ;;
        -H|--header) HEADERS+=("$2"); shift ;;
        *) echo "Unknown parameter: $1"; print_usage ;;
    esac
    shift
done

if [ -z "$URL" ]; then
    echo "Error: URL is required."
    print_usage
fi

# Build Curl Command
# -i: Include headers
# -s: Silent
# -k: Insecure
# -L: NO (Strictly disable redirects to catch 302s)
CMD=(curl -i -s -k -X "$METHOD")

if [ -n "$COOKIE" ]; then
    CMD+=(-H "Cookie: $COOKIE")
fi

CMD+=(-A "$USER_AGENT")

if [ -n "$DATA" ]; then
    CMD+=(-d "$DATA")
fi

for header in "${HEADERS[@]}"; do
    CMD+=(-H "$header")
done

CMD+=("$URL")

echo "Executing: ${CMD[*]}"
RESPONSE=$( "${CMD[@]}" )
EXIT_CODE=$?

if [ $EXIT_CODE -ne 0 ]; then
    echo "Error executing curl command."
    exit 1
fi

echo "--- Response Check ---"

# Check for Success Criteria

FOUND=0

# 1. Check for Location header (301/302)
# We look for "Location: ...baidu.com" or "Location: ...taobao.com"
# grep -i for case insensitivity
if echo "$RESPONSE" | grep -iE "^Location:.*(baidu\.com|taobao\.com)"; then
    echo "[SUCCESS] Open Redirect detected via Location header."
    FOUND=1
fi

# 2. Check for Meta Refresh
# <meta http-equiv="refresh" content="0;url=...baidu.com...">
# We verify if body contains meta refresh to target domains
if [ $FOUND -eq 0 ]; then
    if echo "$RESPONSE" | grep -iE "<meta.*http-equiv=['\"]?refresh['\"]?.*content=.*(baidu\.com|taobao\.com)"; then
        echo "[SUCCESS] Open Redirect detected via Meta Refresh."
        FOUND=1
    fi
fi

# 3. Check for JS Redirect
# window.location.href = ...
if [ $FOUND -eq 0 ]; then
    if echo "$RESPONSE" | grep -iE "window\.location(\.href)?.*=.*(baidu\.com|taobao\.com)"; then
        echo "[SUCCESS] Open Redirect detected via JavaScript."
        FOUND=1
    fi
fi

if [ $FOUND -eq 1 ]; then
    exit 0
else
    echo "[FAIL] No vulnerability verified in response."
    # Optional: Print snippet of response for debugging
    echo "Response snippet:"
    echo "$RESPONSE" | head -n 10
    exit 1
fi
